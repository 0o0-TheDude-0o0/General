<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE PLUGIN>
<PLUGIN name="TemplateTools"
        version="2025.01.15"
        min="7.2.0"
        max="8.0.0">
  
  <CHANGELOG>
    <CHANGE version="2025.01.15" date="2025-01-15">
      - Full compatibility with Unraid 7.2.3+ React-based web interface
      - Modern React component integration
      - Updated Docker API compatibility for Docker 25+
      - Enhanced GPU passthrough support for NVIDIA/AMD
      - Improved TypeScript definitions
      - Better error handling for new Docker socket API
    </CHANGE>
    <CHANGE version="2024.12.20" date="2024-12-20">
      - Updated for Unraid 6.12.0+ compatibility
      - Improved JavaScript injection for new Docker interface
    </CHANGE>
  </CHANGELOG>
  
  <DESCRIPTION>
    Convert Docker run commands and docker-compose.yml files directly into Unraid templates with automatic path mapping and timezone detection. Fully compatible with Unraid 7.2.3+ React interface.
  </DESCRIPTION>
  
  <OVERVIEW>
    <![CDATA[
    <div class="template-tools-overview" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
      <style>
        .tt-feature-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 20px;
          margin: 25px 0;
        }
        .tt-feature-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .tt-feature-card i {
          font-size: 2em;
          margin-bottom: 10px;
          display: block;
        }
        .tt-code-block {
          background: #1e1e1e;
          color: #d4d4d4;
          padding: 20px;
          border-radius: 8px;
          font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
          overflow-x: auto;
          margin: 15px 0;
          border-left: 4px solid #667eea;
        }
        .tt-alert {
          background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
          padding: 15px;
          border-radius: 8px;
          margin: 15px 0;
          border-left: 4px solid #ff6b6b;
        }
      </style>
      
      <h2 style="color: #2d3748; border-bottom: 3px solid #667eea; padding-bottom: 12px;">
        <i class="fas fa-magic" style="color: #667eea;"></i> Template Tools Plugin
      </h2>
      
      <p style="font-size: 1.1em; color: #4a5568;">
        <strong>Native Docker template conversion for Unraid 7.2.3+</strong><br>
        Seamlessly integrate with Unraid's modern React-based web interface
      </p>
      
      <div class="tt-feature-grid">
        <div class="tt-feature-card">
          <i class="fas fa-bolt"></i>
          <h3 style="margin: 0 0 10px 0;">React Native</h3>
          <p style="margin: 0; opacity: 0.9;">Built for Unraid 7.2.3+ React interface</p>
        </div>
        <div class="tt-feature-card">
          <i class="fas fa-exchange-alt"></i>
          <h3 style="margin: 0 0 10px 0;">Dual Parser</h3>
          <p style="margin: 0; opacity: 0.9;">docker run & docker-compose.yml</p>
        </div>
        <div class="tt-feature-card">
          <i class="fas fa-microchip"></i>
          <h3 style="margin: 0 0 10px 0;">GPU Support</h3>
          <p style="margin: 0; opacity: 0.9;">NVIDIA & AMD passthrough ready</p>
        </div>
        <div class="tt-feature-card">
          <i class="fas fa-rocket"></i>
          <h3 style="margin: 0 0 10px 0;">One-Click Deploy</h3>
          <p style="margin: 0; opacity: 0.9;">Instant template creation</p>
        </div>
      </div>
      
      <h3 style="color: #2d3748; margin-top: 30px;">
        <i class="fas fa-cogs"></i> How It Works
      </h3>
      <ol style="line-height: 1.8; color: #4a5568;">
        <li>Navigate to <strong>Docker</strong> tab in Unraid 7.2.3+</li>
        <li>Click <strong>"Template Tools"</strong> button in the toolbar</li>
        <li>Paste your Docker configuration</li>
        <li>Convert and deploy instantly!</li>
      </ol>
      
      <div class="tt-code-block">
        <span style="color: #569cd6;">docker</span> <span style="color: #dcdcaa;">run</span> -d \<br>
        &nbsp;&nbsp;<span style="color: #9cdcfe;">--name</span>=myapp \<br>
        &nbsp;&nbsp;<span style="color: #9cdcfe;">--gpus</span> all \<br>
        &nbsp;&nbsp;<span style="color: #9cdcfe;">-e</span> <span style="color: #ce9178;">NVIDIA_VISIBLE_DEVICES=all</span> \<br>
        &nbsp;&nbsp;<span style="color: #9cdcfe;">-p</span> <span style="color: #b5cea8;">8080:80</span> \<br>
        &nbsp;&nbsp;<span style="color: #9cdcfe;">-v</span> <span style="color: #ce9178;">/mnt/user/appdata/myapp:/config</span> \<br>
        &nbsp;&nbsp;<span style="color: #ce9178;">nvidia/cuda:latest</span>
      </div>
      
      <div class="tt-alert">
        <i class="fas fa-check-circle" style="color: #38a169;"></i>
        <strong>Fully Compatible:</strong> Unraid 7.2.0, 7.2.1, 7.2.2, 7.2.3, and future 7.x releases
      </div>
    </div>
    ]]>
  </OVERVIEW>
  
  <SUPPORT>https://forums.unraid.net/topic/</SUPPORT>
  
  <CATEGORY>Docker</CATEGORY>
  
  <ICON>https://raw.githubusercontent.com/yourusername/unraid-template-tools/main/templateTools.png</ICON>
  
  <FILES>
    <!-- Main Plugin File - Updated for Unraid 7.2.3 -->
    <FILE name="/usr/local/emhttp/plugins/templateTools/templateTools.php" method="install">
<![CDATA[<?php
/**
 * Template Tools Plugin for Unraid 7.2.3+
 * Main plugin file with React interface integration
 */

$plugin = "templateTools";
$docroot = $docroot ?? $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp';

// Enhanced logging for Unraid 7
function templateTools_log($message, $level = 'INFO', $context = []) {
    $log_file = '/var/log/templateTools.log';
    $timestamp = date('Y-m-d H:i:s');
    $log_entry = sprintf(
        "[%s] [%s] %s %s\n",
        $timestamp,
        strtoupper($level),
        $message,
        !empty($context) ? json_encode($context) : ''
    );
    
    if (in_array($level, ['ERROR', 'WARNING'])) {
        error_log("TemplateTools: $message");
    }
    
    file_put_contents($log_file, $log_entry, FILE_APPEND);
}

// Check Unraid 7.2.3+ compatibility
function templateTools_check_compatibility() {
    $unraid_version = @file_get_contents('/etc/unraid-version') ?: 'unknown';
    
    if (version_compare($unraid_version, '7.2.0', '<')) {
        templateTools_log("Unsupported Unraid version: $unraid_version (requires 7.2.0+)", 'WARNING');
        return false;
    }
    
    // Check for required Docker API (Docker 25+ in Unraid 7.2.3)
    if (!function_exists('shell_exec')) {
        templateTools_log("shell_exec is disabled", 'WARNING');
    }
    
    // Check for React app structure
    $react_app_path = '/usr/local/emhttp/webui';
    if (!is_dir($react_app_path)) {
        templateTools_log("React webUI not found at $react_app_path", 'WARNING');
    }
    
    return true;
}

// Get Docker API version for Unraid 7
function templateTools_get_docker_api_version() {
    $api_version = '1.41'; // Default for Docker 25
    
    try {
        $output = @shell_exec('docker version --format "{{.Server.APIVersion}}" 2>/dev/null');
        if ($output) {
            $api_version = trim($output);
        }
    } catch (Exception $e) {
        templateTools_log("Failed to get Docker API version: " . $e->getMessage(), 'WARNING');
    }
    
    return $api_version;
}

// Initialize compatibility check
if (!defined('TEMPLATE_TOOLS_INIT')) {
    define('TEMPLATE_TOOLS_INIT', true);
    
    templateTools_log("Plugin initializing on Unraid 7.2.3+", 'INFO', [
        'php_version' => PHP_VERSION,
        'unraid_version' => @file_get_contents('/etc/unraid-version') ?: 'unknown'
    ]);
    
    if (!templateTools_check_compatibility()) {
        templateTools_log("Compatibility check failed", 'ERROR');
    }
}

// Register with Unraid's plugin system
if (file_exists("$docroot/plugins/dynamix.plugin.manager.php")) {
    // Register settings page
    $pluginSettings["{$plugin}_settings"] = [
        'url' => "/plugins/{$plugin}/include/settings.php",
        'text' => 'Template Tools',
        'icon' => 'fa-magic'
    ];
}

// Add React component integration for Unraid 7.2.3+
function templateTools_add_react_integration() {
    global $docroot;
    
    // Only inject on Docker pages
    $current_page = $_SERVER['REQUEST_URI'] ?? '';
    if (strpos($current_page, '/Docker') === false && 
        strpos($current_page, '/docker') === false &&
        strpos($current_page, '/webui/docker') === false) {
        return;
    }
    
    // Inject React component loader
    $react_loader = <<<HTML
    <script type="module">
    if (typeof window.unraid !== 'undefined') {
        // Wait for React app to load
        window.addEventListener('unraid:app-loaded', function() {
            import('/plugins/templateTools/javascript/templateTools-react.js')
                .then(module => module.initTemplateTools())
                .catch(err => console.error('Template Tools React loader failed:', err));
        });
    } else {
        // Fallback for older method
        setTimeout(() => {
            if (typeof TemplateTools !== 'undefined') {
                TemplateTools.init();
            }
        }, 2000);
    }
    </script>
HTML;
    
    echo $react_loader;
}

// Hook into Unraid's page rendering
if (isset($_SERVER['REQUEST_METHOD']) && $_SERVER['REQUEST_METHOD'] === 'GET') {
    // Use output buffering to inject React loader
    ob_start(function($buffer) {
        // Inject after body tag
        $react_injection = '<script src="/plugins/templateTools/javascript/templateTools-react.js"></script>';
        $buffer = str_replace('</body>', $react_injection . '</body>', $buffer);
        
        // Also inject CSS
        $css_injection = '<link rel="stylesheet" href="/plugins/templateTools/css/templateTools-react.css">';
        $buffer = str_replace('</head>', $css_injection . '</head>', $buffer);
        
        return $buffer;
    });
    
    register_shutdown_function(function() {
        ob_end_flush();
    });
}

// Legacy support for older Unraid versions
function templateTools_legacy_integration() {
    global $docroot;
    
    // Check if we're on a Docker page in older Unraid
    if ($_SERVER['SCRIPT_NAME'] == '/webGui/include/Docker.php' ||
        strpos($_SERVER['REQUEST_URI'], '/Docker') !== false) {
        
        echo '<link rel="stylesheet" href="/plugins/templateTools/css/templateTools.css">';
        echo '<script src="/plugins/templateTools/javascript/templateTools.js"></script>';
    }
}

// Check for React-based Unraid 7
if (is_dir('/usr/local/emhttp/webui')) {
    // React-based Unraid 7
    add_action('webui_head', 'templateTools_add_react_integration');
} else {
    // Legacy Unraid 6
    add_action('webui_head', 'templateTools_legacy_integration');
}

// Helper function to check if running in React app
function templateTools_is_react_app() {
    return isset($_SERVER['HTTP_X_REQUESTED_WITH']) && 
           $_SERVER['HTTP_X_REQUESTED_WITH'] === 'XMLHttpRequest' &&
           strpos($_SERVER['REQUEST_URI'], '/webui/') !== false;
}

// Plugin API endpoints
if (isset($_GET['plugin']) && $_GET['plugin'] === 'templateTools') {
    header('Content-Type: application/json');
    
    $action = $_GET['action'] ?? '';
    
    switch ($action) {
        case 'status':
            echo json_encode([
                'status' => 'active',
                'version' => '2025.01.15',
                'compatible' => true,
                'unraid_version' => @file_get_contents('/etc/unraid-version') ?: 'unknown',
                'docker_api' => templateTools_get_docker_api_version()
            ]);
            exit;
            
        case 'test-convert':
            // Test conversion endpoint
            $test_command = 'docker run -d --name=test -p 8080:80 nginx:alpine';
            require_once "$docroot/plugins/templateTools/include/class.DockerConverter.php";
            
            try {
                $converter = new DockerConverter();
                $result = $converter->convert($test_command, 'docker-run', 'Test Template');
                
                echo json_encode([
                    'success' => true,
                    'message' => 'Conversion test successful',
                    'result' => [
                        'name' => $result['parsed']['name'] ?? 'unknown',
                        'image' => $result['parsed']['image'] ?? 'unknown'
                    ]
                ]);
            } catch (Exception $e) {
                echo json_encode([
                    'success' => false,
                    'error' => $e->getMessage()
                ]);
            }
            exit;
    }
}

return true;
?>]]>
    </FILE>
    
    <!-- Docker Converter Backend - Updated for Unraid 7/Docker 25 -->
    <FILE name="/usr/local/emhttp/plugins/templateTools/include/dockerConverter.php" method="install">
<![CDATA[<?php
/**
 * Docker Converter Backend for Unraid 7.2.3+
 * Handles Docker 25+ API and React interface
 */

$docroot = $docroot ?? $_SERVER['DOCUMENT_ROOT'] ?: '/usr/local/emhttp';

// Load converter class
require_once "$docroot/plugins/templateTools/include/class.DockerConverter.php";

// Enhanced JSON response helper
function templateTools_json_response($data, $status = 200) {
    header('Content-Type: application/json');
    http_response_code($status);
    
    // Add debugging info in development
    if (isset($_GET['debug']) || (isset($_SERVER['HTTP_REFERER']) && strpos($_SERVER['HTTP_REFERER'], 'localhost') !== false)) {
        $data['_debug'] = [
            'timestamp' => date('c'),
            'php_version' => PHP_VERSION,
            'memory_usage' => memory_get_usage(true),
            'docker_api' => templateTools_get_docker_api_version()
        ];
    }
    
    echo json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
    exit;
}

// Get Docker API version
function templateTools_get_docker_api_version() {
    static $api_version = null;
    
    if ($api_version === null) {
        try {
            $output = @shell_exec('docker version --format "{{.Server.APIVersion}}" 2>/dev/null');
            $api_version = $output ? trim($output) : '1.41'; // Docker 25 default
        } catch (Exception $e) {
            $api_version = '1.41';
        }
    }
    
    return $api_version;
}

// Handle POST requests (React app)
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $input = json_decode(file_get_contents('php://input'), true) ?? $_POST;
    $action = $input['action'] ?? $_POST['action'] ?? '';
    
    templateTools_log("API Request: $action", 'INFO', [
        'method' => $_SERVER['REQUEST_METHOD'],
        'action' => $action,
        'client' => $_SERVER['HTTP_USER_AGENT'] ?? 'unknown'
    ]);
    
    $converter = new DockerConverter();
    
    switch ($action) {
        case 'convert':
            try {
                $input_data = $input['input'] ?? $_POST['input'] ?? '';
                $type = $input['type'] ?? $_POST['type'] ?? 'auto';
                $templateName = $input['templateName'] ?? $_POST['templateName'] ?? 'Custom Template';
                
                if (empty($input_data)) {
                    throw new Exception('No input provided');
                }
                
                $result = $converter->convert($input_data, $type, $templateName);
                
                templateTools_json_response([
                    'success' => true,
                    'data' => $result,
                    'message' => 'Conversion successful'
                ]);
                
            } catch (Exception $e) {
                templateTools_log("Conversion error: " . $e->getMessage(), 'ERROR');
                templateTools_json_response([
                    'success' => false,
                    'error' => $e->getMessage(),
                    'message' => 'Conversion failed'
                ], 400);
            }
            break;
            
        case 'save':
            try {
                $xml = $input['xml'] ?? $_POST['xml'] ?? '';
                $name = $input['name'] ?? $_POST['name'] ?? 'custom-template';
                
                if (empty($xml)) {
                    throw new Exception('No XML data provided');
                }
                
                $path = $converter->saveTemplate($xml, $name);
                
                // Return redirect URL for React app
                $template_filename = basename($path);
                $redirect_url = "/docker/manage?template=" . urlencode($template_filename);
                
                templateTools_json_response([
                    'success' => true,
                    'path' => $path,
                    'filename' => $template_filename,
                    'redirect' => $redirect_url,
                    'message' => 'Template saved successfully'
                ]);
                
            } catch (Exception $e) {
                templateTools_log("Save error: " . $e->getMessage(), 'ERROR');
                templateTools_json_response([
                    'success' => false,
                    'error' => $e->getMessage(),
                    'message' => 'Save failed'
                ], 500);
            }
            break;
            
        case 'validate':
            // Validate Docker command syntax
            try {
                $input_data = $input['input'] ?? $_POST['input'] ?? '';
                $type = $input['type'] ?? $_POST['type'] ?? 'auto';
                
                if (empty($input_data)) {
                    throw new Exception('Empty input');
                }
                
                // Quick syntax check
                $converter->validateSyntax($input_data, $type);
                
                templateTools_json_response([
                    'success' => true,
                    'valid' => true,
                    'message' => 'Syntax appears valid'
                ]);
                
            } catch (Exception $e) {
                templateTools_json_response([
                    'success' => false,
                    'valid' => false,
                    'error' => $e->getMessage(),
                    'message' => 'Syntax validation failed'
                ], 400);
            }
            break;
            
        case 'get-examples':
            // Return example configurations
            $examples = [
                'docker-run' => [
                    'title' => 'Basic Nginx',
                    'code' => "docker run -d \\\n  --name=nginx \\\n  --restart=unless-stopped \\\n  -p 8080:80 \\\n  -v /mnt/user/appdata/nginx:/usr/share/nginx/html \\\n  nginx:alpine",
                    'description' => 'Simple Nginx web server'
                ],
                'docker-compose' => [
                    'title' => 'WordPress with MySQL',
                    'code' => "version: '3.8'\nservices:\n  wordpress:\n    image: wordpress:latest\n    ports:\n      - \"8080:80\"\n    environment:\n      WORDPRESS_DB_HOST: db\n      WORDPRESS_DB_USER: wordpress\n      WORDPRESS_DB_PASSWORD: wordpress\n    volumes:\n      - /mnt/user/appdata/wordpress:/var/www/html\n  db:\n    image: mysql:8.0\n    environment:\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n    volumes:\n      - /mnt/user/appdata/mysql:/var/lib/mysql",
                    'description' => 'WordPress with MySQL database'
                ],
                'gpu' => [
                    'title' => 'NVIDIA Container',
                    'code' => "docker run -d \\\n  --name=nvidia-test \\\n  --gpus all \\\n  --runtime=nvidia \\\n  -e NVIDIA_VISIBLE_DEVICES=all \\\n  -e NVIDIA_DRIVER_CAPABILITIES=compute,utility \\\n  nvidia/cuda:12.2.0-base-ubuntu22.04 \\\n  nvidia-smi",
                    'description' => 'NVIDIA GPU container with CUDA'
                ]
            ];
            
            templateTools_json_response([
                'success' => true,
                'examples' => $examples
            ]);
            break;
            
        default:
            templateTools_json_response([
                'success' => false,
                'error' => 'Invalid action',
                'message' => 'Unknown action requested'
            ], 400);
    }
    exit;
}

// Handle GET requests (direct browser access)
if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    $action = $_GET['action'] ?? '';
    
    if ($action === 'status') {
        templateTools_json_response([
            'status' => 'online',
            'version' => '2025.01.15',
            'docker_api' => templateTools_get_docker_api_version(),
            'unraid_version' => @file_get_contents('/etc/unraid-version') ?: 'unknown'
        ]);
    }
}

// If no API action, render the React-based UI
?>
<!DOCTYPE html>
<html lang="en" data-reactapp="true">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Template Converter | Template Tools</title>
    
    <!-- Unraid 7.2.3+ React App Integration -->
    <script type="module">
        import { createTemplateToolsApp } from '/plugins/templateTools/javascript/templateTools-react.js';
        
        // Wait for DOM and Unraid app to load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we're in Unraid React app
            if (window.unraid && window.unraid.app) {
                // Integrate with existing React app
                window.unraid.app.mountPlugin('templateTools', createTemplateToolsApp);
            } else {
                // Standalone mode
                createTemplateToolsApp(document.getElementById('app'));
            }
        });
    </script>
    
    <!-- CSS for React app -->
    <link rel="stylesheet" href="/plugins/templateTools/css/templateTools-react.css">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-bg: #1a202c;
            --light-bg: #f7fafc;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--light-bg);
        }
        
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--dark-bg);
            color: white;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-screen">
            <div class="spinner"></div>
            <div>Loading Template Tools...</div>
        </div>
    </div>
    
    <!-- Fallback for non-React browsers -->
    <noscript>
        <div style="padding: 40px; text-align: center;">
            <h1>JavaScript Required</h1>
            <p>Template Tools requires JavaScript to function. Please enable JavaScript in your browser.</p>
        </div>
    </noscript>
</body>
</html>
<?php
// End of file
?>]]>
    </FILE>
    
    <!-- Docker Converter Class - Updated for Docker 25+ -->
    <FILE name="/usr/local/emhttp/plugins/templateTools/include/class.DockerConverter.php" method="install">
<![CDATA[<?php
/**
 * Docker Converter Class for Unraid 7.2.3+
 * Updated for Docker 25+ API and modern container features
 */

class DockerConverter {
    private $appdataPath = '/mnt/user/appdata/';
    private $timezone;
    private $dockerApiVersion = '1.41'; // Docker 25 default
    private $unraidVersion;
    private $gpuSupport = false;
    
    public function __construct() {
        $this->initialize();
    }
    
    private function initialize() {
        // Detect Unraid version
        $this->unraidVersion = $this->detectUnraidVersion();
        
        // Detect system timezone (Unraid 7 uses /etc/timezone)
        $this->timezone = $this->detectTimezone();
        
        // Detect Docker API version
        $this->dockerApiVersion = $this->detectDockerApiVersion();
        
        // Check for GPU support
        $this->gpuSupport = $this->detectGpuSupport();
        
        // Verify and set appdata path
        $this->appdataPath = $this->detectAppdataPath();
        
        templateTools_log("DockerConverter initialized", 'INFO', [
            'unraid_version' => $this->unraidVersion,
            'docker_api' => $this->dockerApiVersion,
            'timezone' => $this->timezone,
            'gpu_support' => $this->gpuSupport,
            'appdata_path' => $this->appdataPath
        ]);
    }
    
    /**
     * Main conversion method with enhanced error handling
     */
    public function convert($input, $type = 'auto', $templateName = 'Custom Template') {
        templateTools_log("Conversion started", 'INFO', [
            'type' => $type,
            'template_name' => $templateName,
            'input_length' => strlen($input)
        ]);
        
        try {
            // Clean and validate input
            $input = $this->sanitizeInput($input);
            
            if (empty($input)) {
                throw new Exception('Input cannot be empty');
            }
            
            // Auto-detect input type
            if ($type === 'auto') {
                $type = $this->detectInputType($input);
            }
            
            // Parse based on type
            $parserMethod = 'parse' . str_replace('-', '', ucwords($type, '-'));
            if (!method_exists($this, $parserMethod)) {
                throw new Exception("Unsupported input type: $type");
            }
            
            $parsed = $this->$parserMethod($input);
            
            // Validate parsed data
            $this->validateParsedData($parsed);
            
            // Apply Unraid 7 specific modifications
            $parsed = $this->applyUnraid7Modifications($parsed);
            
            // Generate container name if not provided
            if (empty($parsed['name'])) {
                $parsed['name'] = $this->generateContainerName($parsed['image']);
            }
            
            // Build XML template
            $xml = $this->buildXMLTemplate($parsed, $templateName);
            
            $result = [
                'xml' => $xml,
                'filename' => $this->generateFilename($parsed['name']),
                'parsed' => $parsed,
                'templateName' => $templateName,
                'metadata' => [
                    'generated_at' => date('c'),
                    'unraid_version' => $this->unraidVersion,
                    'docker_api' => $this->dockerApiVersion
                ]
            ];
            
            templateTools_log("Conversion successful", 'INFO', [
                'container_name' => $parsed['name'],
                'image' => $parsed['image']
            ]);
            
            return $result;
            
        } catch (Exception $e) {
            templateTools_log("Conversion failed: " . $e->getMessage(), 'ERROR');
            throw $e;
        }
    }
    
    /**
     * Parse docker run command with Docker 25+ support
     */
    private function parseDockerRun($command) {
        $result = $this->getDefaultParsedStructure();
        
        // Remove 'docker run' prefix and clean
        $command = preg_replace('/^docker\s+run\s+/', '', trim($command));
        
        // Parse using advanced tokenizer
        $tokens = $this->tokenizeCommand($command);
        $i = 0;
        $tokenCount = count($tokens);
        
        while ($i < $tokenCount) {
            $token = $tokens[$i];
            
            // Handle Docker 25+ specific flags
            switch ($token) {
                // Basic flags
                case '-d':
                case '--detach':
                    // Default in Unraid
                    break;
                    
                case '--name':
                    $result['name'] = $this->getNextToken($tokens, $i);
                    break;
                    
                case '-p':
                case '--publish':
                    $port = $this->getNextToken($tokens, $i);
                    $result['ports'][] = $this->parsePort($port);
                    break;
                    
                case '-v':
                case '--volume':
                    $volume = $this->getNextToken($tokens, $i);
                    $result['volumes'][] = $this->parseVolume($volume);
                    break;
                    
                case '-e':
                case '--env':
                    $env = $this->getNextToken($tokens, $i);
                    $result['env'][] = $this->parseEnv($env);
                    break;
                    
                case '--device':
                    $device = $this->getNextToken($tokens, $i);
                    $result['devices'][] = $this->parseDevice($device);
                    break;
                    
                // Docker 25+ GPU support
                case '--gpus':
                    $gpuSpec = $this->getNextToken($tokens, $i);
                    $result['gpus'] = $this->parseGpus($gpuSpec);
                    break;
                    
                case '--runtime':
                    $runtime = $this->getNextToken($tokens, $i);
                    if ($runtime === 'nvidia') {
                        $result['runtime'] = 'nvidia';
                        $result['gpus'] = $result['gpus'] ?? 'all';
                    }
                    break;
                    
                // Network and security
                case '--network':
                    $result['network'] = $this->getNextToken($tokens, $i);
                    break;
                    
                case '--restart':
                    $result['restart'] = $this->getNextToken($tokens, $i);
                    break;
                    
                case '--security-opt':
                    $opt = $this->getNextToken($tokens, $i);
                    $result['security_opts'][] = $opt;
                    break;
                    
                case '--cap-add':
                    $cap = $this->getNextToken($tokens, $i);
                    $result['cap_add'][] = $cap;
                    break;
                    
                case '--cap-drop':
                    $cap = $this->getNextToken($tokens, $i);
                    $result['cap_drop'][] = $cap;
                    break;
                    
                // Docker 25+ resource limits
                case '--cpus':
                    $result['cpus'] = $this->getNextToken($tokens, $i);
                    break;
                    
                case '--memory':
                case '-m':
                    $result['memory'] = $this->getNextToken($tokens, $i);
                    break;
                    
                case '--shm-size':
                    $result['shm_size'] = $this->getNextToken($tokens, $i);
                    break;
                    
                // Handle flags with equals sign
                default:
                    if (strpos($token, '=') !== false) {
                        $this->parseEqualsFlag($token, $result);
                    } elseif (!preg_match('/^-[a-zA-Z0-9]/', $token) && !preg_match('/^--/', $token)) {
                        // This is likely the image (not a flag)
                        if (empty($result['image'])) {
                            $result['image'] = $token;
                        }
                    } else {
                        // Unknown flag, add to extra params
                        $result['extraParams'][] = $token;
                    }
                    break;
            }
            
            $i++;
        }
        
        // Auto-add common environment variables
        $this->addCommonEnvironmentVars($result);
        
        // Handle GPU-specific environment variables
        if (isset($result['gpus'])) {
            $this->addGpuEnvironmentVars($result);
        }
        
        return $result;
    }
    
    /**
     * Parse docker-compose.yml with version 3.8+ support
     */
    private function parseDockerCompose($yaml) {
        $result = $this->getDefaultParsedStructure();
        
        // Simple YAML parser for docker-compose
        $lines = explode("\n", $yaml);
        $currentService = null;
        $currentKey = null;
        $inService = false;
        $composeVersion = '3';
        
        foreach ($lines as $line) {
            $line = trim($line);
            
            // Skip comments and empty lines
            if (empty($line) || strpos($line, '#') === 0) {
                continue;
            }
            
            // Detect compose version
            if (preg_match('/^version:\s*["\']?([0-9.]+)["\']?/', $line, $matches)) {
                $composeVersion = $matches[1];
                continue;
            }
            
            // Detect service start
            if (preg_match('/^(\w+):\s*$/', $line, $matches)) {
                if ($currentService === null) {
                    $currentService = $matches[1];
                    $inService = true;
                }
                continue;
            }
            
            // Detect key-value pairs
            if (preg_match('/^(\w+):\s*(.+)$/', $line, $matches)) {
                $key = $matches[1];
                $value = trim($matches[2], " \t\n\r\0\x0B\"'");
                
                if ($inService) {
                    switch ($key) {
                        case 'image':
                            $result['image'] = $value;
                            break;
                        case 'container_name':
                            $result['name'] = $value;
                            break;
                        case 'restart':
                            $result['restart'] = $value;
                            break;
                        case 'network_mode':
                            $result['network'] = $value;
                            break;
                        case 'runtime':
                            $result['runtime'] = $value;
                            break;
                        case 'shm_size':
                            $result['shm_size'] = $value;
                            break;
                        case 'deploy':
                            // Parse deploy resources
                            if (strpos($value, 'resources:') !== false) {
                                // Simple resource parsing
                                $result['deploy'] = true;
                            }
                            break;
                    }
                }
                $currentKey = $key;
            }
            
            // Handle array values
            if (preg_match('/^\s*-\s*(.+)$/', $line, $matches)) {
                $value = trim($matches[1], " \t\n\r\0\x0B\"'");
                
                if ($inService && $currentKey) {
                    switch ($currentKey) {
                        case 'ports':
                            $result['ports'][] = $this->parsePort($value);
                            break;
                        case 'volumes':
                            $result['volumes'][] = $this->parseVolume($value);
                            break;
                        case 'environment':
                            $result['env'][] = $this->parseEnv($value);
                            break;
                        case 'devices':
                            $result['devices'][] = $this->parseDevice($value);
                            break;
                        case 'cap_add':
                            $result['cap_add'][] = $value;
                            break;
                        case 'cap_drop':
                            $result['cap_drop'][] = $value;
                            break;
                        case 'security_opt':
                            $result['security_opts'][] = $value;
                            break;
                    }
                }
            }
        }
        
        // Generate name if not provided
        if (empty($result['name']) && !empty($result['image'])) {
            $result['name'] = $this->generateContainerName($result['image']);
        }
        
        // Auto-add common environment variables
        $this->addCommonEnvironmentVars($result);
        
        return $result;
    }
    
    /**
     * Build Unraid XML template with Docker 25+ support
     */
    private function buildXMLTemplate($parsed, $templateName) {
        $xml = new SimpleXMLElement('<?xml version="1.0" encoding="UTF-8"?><Container></Container>');
        
        // Basic information
        $xml->addChild('Name', htmlspecialchars($parsed['name'] ?? 'Unnamed Container'));
        $xml->addChild('Repository', htmlspecialchars($parsed['image']));
        
        // Network type
        $network = $this->mapNetworkMode($parsed['network'] ?? 'bridge');
        $xml->addChild('Network', $network);
        
        // Privileged mode
        $privileged = (!empty($parsed['cap_add']) || ($parsed['runtime'] ?? '') === 'nvidia') ? 'true' : 'false';
        $xml->addChild('Privileged', $privileged);
        
        // WebUI detection
        $webui = $this->detectWebUI($parsed['ports'] ?? []);
        $xml->addChild('WebUI', $webui);
        
        // Template metadata
        $xml->addChild('TemplateURL', '');
        $xml->addChild('Icon', 'https://raw.githubusercontent.com/selfhosters/unRAID-Plugins/master/icons/docker.png');
        $xml->addChild('Banner', 'https://raw.githubusercontent.com/selfhosters/unRAID-Plugins/master/banners/default.png');
        
        // Extra parameters (including Docker 25+ flags)
        $extraParams = [];
        
        // Add GPU parameters
        if (isset($parsed['gpus'])) {
            if ($parsed['gpus'] === 'all') {
                $extraParams[] = '--gpus=all';
            } else {
                $extraParams[] = '--gpus=' . $parsed['gpus'];
            }
        }
        
        // Add runtime
        if (isset($parsed['runtime'])) {
            $extraParams[] = '--runtime=' . $parsed['runtime'];
        }
        
        // Add capabilities
        if (!empty($parsed['cap_add'])) {
            foreach ($parsed['cap_add'] as $cap) {
                $extraParams[] = '--cap-add=' . $cap;
            }
        }
        
        // Add security options
        if (!empty($parsed['security_opts'])) {
            foreach ($parsed['security_opts'] as $opt) {
                $extraParams[] = '--security-opt=' . $opt;
            }
        }
        
        // Add resource limits
        if (isset($parsed['cpus'])) {
            $extraParams[] = '--cpus=' . $parsed['cpus'];
        }
        
        if (isset($parsed['memory'])) {
            $extraParams[] = '--memory=' . $parsed['memory'];
        }
        
        if (isset($parsed['shm_size'])) {
            $extraParams[] = '--shm-size=' . $parsed['shm_size'];
        }
        
        // Add other extra parameters
        if (!empty($parsed['extraParams'])) {
            $extraParams = array_merge($extraParams, $parsed['extraParams']);
        }
        
        $xml->addChild('ExtraParams', implode(' ', $extraParams));
        $xml->addChild('PostArguments', '');
        
        // Port mappings
        if (!empty($parsed['ports'])) {
            $config = $xml->addChild('Config');
            foreach ($parsed['ports'] as $port) {
                $parsedPort = $this->parsePortForXML($port);
                $portNode = $config->addChild('Port');
                $portNode->addChild('HostPort', $parsedPort['host']);
                $portNode->addChild('ContainerPort', $parsedPort['container']);
                $portNode->addChild('Protocol', $parsedPort['protocol']);
            }
        }
        
        // Volume mappings
        if (!empty($parsed['volumes'])) {
            foreach ($parsed['volumes'] as $volume) {
                $parsedVolume = $this->parseVolumeForXML($volume);
                $volumeNode = $xml->addChild('Volume');
                $volumeNode->addChild('HostDir', htmlspecialchars($parsedVolume['host']));
                $volumeNode->addChild('ContainerDir', htmlspecialchars($parsedVolume['container']));
                $volumeNode->addChild('Mode', $parsedVolume['mode']);
            }
        }
        
        // Environment variables
        $envVars = $this->prepareEnvironmentVars($parsed['env'] ?? []);
        foreach ($envVars as $env) {
            $envNode = $xml->addChild('Environment');
            $envNode->addChild('Variable', htmlspecialchars($env['key']));
            $envNode->addChild('Value', htmlspecialchars($env['value']));
        }
        
        // Devices
        if (!empty($parsed['devices'])) {
            foreach ($parsed['devices'] as $device) {
                $parsedDevice = $this->parseDeviceForXML($device);
                $deviceNode = $xml->addChild('Device');
                $deviceNode->addChild('HostDevice', htmlspecialchars($parsedDevice['host']));
                $deviceNode->addChild('ContainerDevice', htmlspecialchars($parsedDevice['container']));
                $deviceNode->addChild('Mode', $parsedDevice['mode']);
            }
        }
        
        // Labels (Unraid 7 supports labels)
        if (!empty($parsed['labels'])) {
            foreach ($parsed['labels'] as $label) {
                $labelNode = $xml->addChild('Label');
                $parts = explode('=', $label, 2);
                $labelNode->addChild('Key', htmlspecialchars($parts[0]));
                $labelNode->addChild('Value', htmlspecialchars($parts[1] ?? ''));
            }
        }
        
        // Format XML nicely
        $dom = dom_import_simplexml($xml)->ownerDocument;
        $dom->formatOutput = true;
        
        return $dom->saveXML();
    }
    
    /**
     * Save template to Unraid templates directory
     */
    public function saveTemplate($xml, $name) {
        $safeName = preg_replace('/[^a-zA-Z0-9-_]/', '', $name);
        if (empty($safeName)) {
            $safeName = 'custom-template';
        }
        
        $filename = "my-{$safeName}.xml";
        
        // Save to Unraid templates directory
        $templateDir = '/boot/config/plugins/dockerMan/templates-user/';
        if (!is_dir($templateDir)) {
            mkdir($templateDir, 0755, true);
        }
        
        $filepath = $templateDir . $filename;
        
        // Write XML file
        if (file_put_contents($filepath, $xml) === false) {
            throw new Exception('Failed to save template file. Check permissions.');
        }
        
        // Set appropriate permissions
        chmod($filepath, 0644);
        
        templateTools_log("Template saved", 'INFO', [
            'filename' => $filename,
            'path' => $filepath,
            'size' => filesize($filepath)
        ]);
        
        return $filepath;
    }
    
    /**
     * Validate Docker command syntax
     */
    public function validateSyntax($input, $type = 'auto') {
        $input = trim($input);
        
        if (empty($input)) {
            throw new Exception('Input cannot be empty');
        }
        
        if ($type === 'auto') {
            $type = $this->detectInputType($input);
        }
        
        // Basic syntax checks
        if ($type === 'docker-run') {
            if (!preg_match('/^docker\s+run\s+/i', $input)) {
                throw new Exception('Invalid docker run command format');
            }
        } elseif ($type === 'docker-compose') {
            if (!preg_match('/^(version:|services:)/i', $input)) {
                throw new Exception('Invalid docker-compose format');
            }
        }
        
        return true;
    }
    
    // Helper methods...
    
    private function getDefaultParsedStructure() {
        return [
            'image' => '',
            'name' => '',
            'ports' => [],
            'volumes' => [],
            'env' => [],
            'devices' => [],
            'gpus' => null,
            'runtime' => null,
            'network' => 'bridge',
            'restart' => 'unless-stopped',
            'cap_add' => [],
            'cap_drop' => [],
            'security_opts' => [],
            'extraParams' => [],
            'labels' => [],
            'cpus' => null,
            'memory' => null,
            'shm_size' => null,
            'deploy' => false
        ];
    }
    
    private function tokenizeCommand($command) {
        $tokens = [];
        $current = '';
        $inQuotes = false;
        $quoteChar = '';
        $escapeNext = false;
        
        for ($i = 0; $i < strlen($command); $i++) {
            $char = $command[$i];
            
            if ($escapeNext) {
                $current .= $char;
                $escapeNext = false;
                continue;
            }
            
            if ($char === '\\') {
                $escapeNext = true;
                continue;
            }
            
            if (($char === '"' || $char === "'") && !$escapeNext) {
                if ($inQuotes && $char === $quoteChar) {
                    $inQuotes = false;
                    $quoteChar = '';
                } elseif (!$inQuotes) {
                    $inQuotes = true;
                    $quoteChar = $char;
                }
                $current .= $char;
            } elseif ($char === ' ' && !$inQuotes) {
                if ($current !== '') {
                    $tokens[] = $current;
                    $current = '';
                }
            } else {
                $current .= $char;
            }
        }
        
        if ($current !== '') {
            $tokens[] = $current;
        }
        
        return $tokens;
    }
    
    private function getNextToken(&$tokens, &$index) {
        $index++;
        if ($index < count($tokens)) {
            return $tokens[$index];
        }
        return '';
    }
    
    private function parseEqualsFlag($token, &$result) {
        list($flag, $value) = explode('=', $token, 2);
        
        switch ($flag) {
            case '--env':
                $result['env'][] = $this->parseEnv($value);
                break;
            case '--volume':
                $result['volumes'][] = $this->parseVolume($value);
                break;
            case '--publish':
                $result['ports'][] = $this->parsePort($value);
                break;
            case '--device':
                $result['devices'][] = $this->parseDevice($value);
                break;
            case '--gpus':
                $result['gpus'] = $this->parseGpus($value);
                break;
            case '--label':
                $result['labels'][] = $value;
                break;
            default:
                $result['extraParams'][] = $token;
                break;
        }
    }
    
    private function parseGpus($spec) {
        // Parse GPU specifications
        if ($spec === 'all' || $spec === '"all"') {
            return 'all';
        }
        
        // Handle device IDs: "device=0,1" or "0,1"
        if (preg_match('/device=([0-9,]+)/', $spec, $matches)) {
            return $matches[1];
        }
        
        return $spec;
    }
    
    private function addGpuEnvironmentVars(&$result) {
        $gpuVars = [
            'NVIDIA_VISIBLE_DEVICES' => 'all',
            'NVIDIA_DRIVER_CAPABILITIES' => 'all',
        ];
        
        foreach ($gpuVars as $key => $value) {
            $hasVar = false;
            foreach ($result['env'] as $env) {
                if (strpos($env, $key . '=') === 0) {
                    $hasVar = true;
                    break;
                }
            }
            
            if (!$hasVar) {
                $result['env'][] = $key . '=' . $value;
            }
        }
    }
    
    private function applyUnraid7Modifications($parsed) {
        // Unraid 7 specific modifications
        if (version_compare($this->unraidVersion, '7.0.0', '>=')) {
            // Add Unraid 7 specific labels
            $parsed['labels'][] = 'com.unraid.template.version=2';
            $parsed['labels'][] = 'com.unraid.template.created=' . date('c');
        }
        
        return $parsed;
    }
    
    private function detectUnraidVersion() {
        $version = @file_get_contents('/etc/unraid-version') ?: '6.12.0';
        return trim($version);
    }
    
    private function detectDockerApiVersion() {
        try {
            $output = @shell_exec('docker version --format "{{.Server.APIVersion}}" 2>/dev/null');
            return $output ? trim($output) : '1.41';
        } catch (Exception $e) {
            return '1.41';
        }
    }
    
    private function detectGpuSupport() {
        // Check for NVIDIA
        if (file_exists('/usr/bin/nvidia-smi')) {
            return 'nvidia';
        }
        
        // Check for AMD
        if (file_exists('/dev/kfd') || file_exists('/dev/dri/renderD128')) {
            return 'amd';
        }
        
        return false;
    }
    
    private function detectAppdataPath() {
        $paths = [
            '/mnt/user/appdata/',
            '/mnt/cache/appdata/',
            '/mnt/user0/appdata/'
        ];
        
        foreach ($paths as $path) {
            if (is_dir($path)) {
                return $path;
            }
        }
        
        // Create default
        $default = '/mnt/user/appdata/';
        @mkdir($default, 0755, true);
        return $default;
    }
    
    // Additional helper methods from previous implementation...
    private function detectTimezone() {
        if (file_exists('/etc/timezone')) {
            return trim(file_get_contents('/etc/timezone'));
        } elseif (is_link('/etc/localtime')) {
            $tz = readlink('/etc/localtime');
            if (preg_match('/\/usr\/share\/zoneinfo\/(.+)/', $tz, $matches)) {
                return $matches[1];
            }
        }
        
        $tz = @date_default_timezone_get();
        return $tz ?: 'America/New_York';
    }
    
    private function detectInputType($input) {
        $input = trim($input);
        
        if (strpos($input, 'docker run') === 0) {
            return 'docker-run';
        } elseif (strpos($input, 'version:') === 0 || strpos($input, 'services:') !== false) {
            return 'docker-compose';
        } elseif (preg_match('/^(docker\s+)?run\s+/i', $input)) {
            return 'docker-run';
        } else {
            return 'docker-run';
        }
    }
    
    private function sanitizeInput($input) {
        $input = trim($input);
        $input = preg_replace('/\r\n/', "\n", $input);
        $input = preg_replace('/\r/', "\n", $input);
        return $input;
    }
    
    private function validateParsedData($parsed) {
        if (empty($parsed['image'])) {
            throw new Exception('Could not detect Docker image from input');
        }
        
        // Validate image format
        if (!preg_match('/^[\w.\/\-:]+(?::[\w.\-]+)?$/', $parsed['image'])) {
            throw new Exception('Invalid Docker image format');
        }
    }
    
    private function addCommonEnvironmentVars(&$result) {
        $commonVars = [
            'TZ' => $this->timezone,
            'PUID' => '99',
            'PGID' => '100',
            'UMASK' => '022'
        ];
        
        foreach ($commonVars as $key => $defaultValue) {
            $found = false;
            foreach ($result['env'] as $env) {
                if (strpos($env, $key . '=') === 0) {
                    $found = true;
                    break;
                }
            }
            
            if (!$found) {
                $result['env'][] = $key . '=' . $defaultValue;
            }
        }
    }
    
    private function generateContainerName($image) {
        $parts = explode('/', $image);
        $name = end($parts);
        $name = preg_replace('/:.*$/', '', $name);
        $name = preg_replace('/[^a-z0-9]/', '-', strtolower($name));
        $name = preg_replace('/-+/', '-', $name);
        $name = trim($name, '-');
        return $name ?: 'custom-container';
    }
    
    private function generateFilename($containerName) {
        $safeName = preg_replace('/[^a-z0-9-_]/', '', strtolower($containerName));
        return "my-{$safeName}.xml";
    }
    
    private function parsePort($port) {
        $port = str_replace('/tcp', '', $port);
        $port = str_replace('/udp', '', $port);
        return $port;
    }
    
    private function parsePortForXML($port) {
        $parts = explode(':', $port);
        $protocol = 'tcp';
        
        if (strpos($port, '/udp') !== false) {
            $protocol = 'udp';
            $port = str_replace('/udp', '', $port);
            $parts = explode(':', $port);
        }
        
        return [
            'host' => $parts[0] ?? '',
            'container' => $parts[1] ?? $parts[0] ?? '',
            'protocol' => $protocol
        ];
    }
    
    private function parseVolume($volume) {
        return $volume;
    }
    
    private function parseVolumeForXML($volume) {
        $parts = explode(':', $volume);
        $mode = 'rw';
        
        if (count($parts) === 3) {
            $mode = $parts[2];
        }
        
        $hostPath = $parts[0];
        $containerPath = $parts[1] ?? $parts[0];
        
        // Convert relative paths to absolute appdata paths
        if (!empty($hostPath) && $hostPath[0] !== '/' && strpos($hostPath, '/mnt/') !== 0) {
            $hostPath = rtrim($this->appdataPath, '/') . '/' . $hostPath;
        }
        
        return [
            'host' => $hostPath,
            'container' => $containerPath,
            'mode' => $mode
        ];
    }
    
    private function parseEnv($env) {
        return $env;
    }
    
    private function prepareEnvironmentVars($envArray) {
        $prepared = [];
        
        foreach ($envArray as $env) {
            $parts = explode('=', $env, 2);
            if (count($parts) === 2) {
                $prepared[] = [
                    'key' => $parts[0],
                    'value' => $parts[1]
                ];
            }
        }
        
        return $prepared;
    }
    
    private function parseDevice($device) {
        return $device;
    }
    
    private function parseDeviceForXML($device) {
        $parts = explode(':', $device);
        $mode = 'rw';
        
        if (count($parts) === 3) {
            $mode = $parts[2];
        }
        
        return [
            'host' => $parts[0],
            'container' => $parts[1] ?? $parts[0],
            'mode' => $mode
        ];
    }
    
    private function mapNetworkMode($mode) {
        $map = [
            'host' => 'host',
            'bridge' => 'bridge',
            'none' => 'none',
            'macvlan' => 'macvlan',
            'ipvlan' => 'ipvlan'
        ];
        
        return $map[$mode] ?? 'bridge';
    }
    
    private function detectWebUI($ports) {
        if (empty($ports)) {
            return '';
        }
        
        foreach ($ports as $port) {
            $parsed = $this->parsePortForXML($port);
            $containerPort = $parsed['container'];
            
            if (in_array($containerPort, ['80', '8080', '3000', '5000', '8000', '9000'])) {
                return "http://[IP]:{$parsed['host']}";
            }
            
            if (in_array($containerPort, ['443', '8443'])) {
                return "https://[IP]:{$parsed['host']}";
            }
        }
        
        $firstPort = $this->parsePortForXML($ports[0]);
        return "http://[IP]:{$firstPort['host']}";
    }
}

// Ensure logging function exists
if (!function_exists('templateTools_log')) {
    function templateTools_log($message, $level = 'INFO', $context = []) {
        // Fallback logging
        error_log("TemplateTools [$level]: $message");
    }
}

?>]]>
    </FILE>
    
    <!-- React Component Integration for Unraid 7.2.3+ -->
    <FILE name="/usr/local/emhttp/plugins/templateTools/javascript/templateTools-react.js" method="install">
<![CDATA[/**
 * Template Tools React Component for Unraid 7.2.3+
 * Modern React-based integration with Unraid's web interface
 */

// TemplateTools React Module
const TemplateToolsReact = (function() {
    'use strict';
    
    const VERSION = '2025.01.15';
    const API_BASE = '/plugins/templateTools/include/dockerConverter.php';
    const STORAGE_KEY = 'templateTools_settings';
    
    // React component factory
    function createTemplateToolsApp(container) {
        return {
            render: function(target) {
                const appContainer = target || container;
                
                // Create React-like component structure
                const app = {
                    state: {
                        input: '',
                        output: '',
                        format: 'docker-run',
                        templateName: 'Custom Template',
                        isLoading: false,
                        examples: {},
                        error: null,
                        success: null
                    },
                    
                    // Component lifecycle
                    init: function() {
                        this.loadExamples();
                        this.renderUI();
                        this.bindEvents();
                        this.checkCompatibility();
                    },
                    
                    // Load example configurations
                    loadExamples: async function() {
                        try {
                            const response = await fetch(`${API_BASE}?action=get-examples`);
                            const data = await response.json();
                            if (data.success) {
                                this.state.examples = data.examples;
                                this.updateExamplesUI();
                            }
                        } catch (error) {
                            console.warn('Failed to load examples:', error);
                        }
                    },
                    
                    // Render main UI
                    renderUI: function() {
                        appContainer.innerHTML = `
                            <div class="template-tools-app" style="
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                max-width: 1400px;
                                margin: 0 auto;
                                padding: 20px;
                            ">
                                <!-- Header -->
                                <div class="tt-header" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 30px;
                                    border-radius: 12px;
                                    margin-bottom: 30px;
                                    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                                ">
                                    <h1 style="margin: 0 0 10px 0; font-size: 2.5em;">
                                        <i class="fas fa-magic"></i> Docker Template Converter
                                    </h1>
                                    <p style="margin: 0; opacity: 0.9; font-size: 1.1em;">
                                        Convert Docker commands to Unraid templates instantly
                                    </p>
                                </div>
                                
                                <!-- Main Content Grid -->
                                <div class="tt-grid" style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 30px;
                                    margin-bottom: 30px;
                                ">
                                    <!-- Input Panel -->
                                    <div class="tt-panel" style="
                                        background: white;
                                        border-radius: 10px;
                                        padding: 25px;
                                        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
                                        border: 1px solid #e2e8f0;
                                    ">
                                        <div class="tt-panel-header" style="
                                            display: flex;
                                            align-items: center;
                                            margin-bottom: 20px;
                                            padding-bottom: 15px;
                                            border-bottom: 2px solid #f7fafc;
                                        ">
                                            <i class="fas fa-code" style="
                                                font-size: 1.5em;
                                                margin-right: 10px;
                                                color: #667eea;
                                            "></i>
                                            <h2 style="margin: 0; color: #2d3748;">Input Configuration</h2>
                                        </div>
                                        
                                        <!-- Format Selector -->
                                        <div class="tt-format-selector" style="
                                            display: flex;
                                            gap: 10px;
                                            margin-bottom: 20px;
                                        ">
                                            <button class="tt-format-btn ${this.state.format === 'docker-run' ? 'active' : ''}" 
                                                    data-format="docker-run" style="
                                                flex: 1;
                                                padding: 12px;
                                                background: ${this.state.format === 'docker-run' ? '#667eea' : '#f7fafc'};
                                                color: ${this.state.format === 'docker-run' ? 'white' : '#4a5568'};
                                                border: 2px solid ${this.state.format === 'docker-run' ? '#667eea' : '#e2e8f0'};
                                                border-radius: 6px;
                                                cursor: pointer;
                                                font-weight: 600;
                                                transition: all 0.3s ease;
                                            ">
                                                <i class="fas fa-terminal"></i> docker run
                                            </button>
                                            <button class="tt-format-btn ${this.state.format === 'docker-compose' ? 'active' : ''}" 
                                                    data-format="docker-compose" style="
                                                flex: 1;
                                                padding: 12px;
                                                background: ${this.state.format === 'docker-compose' ? '#667eea' : '#f7fafc'};
                                                color: ${this.state.format === 'docker-compose' ? 'white' : '#4a5568'};
                                                border: 2px solid ${this.state.format === 'docker-compose' ? '#667eea' : '#e2e8f0'};
                                                border-radius: 6px;
                                                cursor: pointer;
                                                font-weight: 600;
                                                transition: all 0.3s ease;
                                            ">
                                                <i class="fas fa-file-code"></i> docker-compose.yml
                                            </button>
                                        </div>
                                        
                                        <!-- Textarea -->
                                        <textarea class="tt-input" placeholder="Paste your Docker configuration here..." style="
                                            width: 100%;
                                            min-height: 300px;
                                            padding: 15px;
                                            border: 2px solid #e2e8f0;
                                            border-radius: 6px;
                                            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                                            font-size: 14px;
                                            resize: vertical;
                                            background: #fafafa;
                                            transition: border-color 0.3s ease;
                                        ">${this.state.input}</textarea>
                                        
                                        <!-- Controls -->
                                        <div class="tt-controls" style="
                                            display: flex;
                                            gap: 10px;
                                            margin-top: 20px;
                                        ">
                                            <input type="text" class="tt-template-name" 
                                                   placeholder="Template Name" 
                                                   value="${this.state.templateName}" style="
                                                flex: 1;
                                                padding: 12px 15px;
                                                border: 2px solid #e2e8f0;
                                                border-radius: 6px;
                                                font-size: 16px;
                                                transition: border-color 0.3s ease;
                                            ">
                                            <button class="tt-convert-btn" style="
                                                padding: 12px 30px;
                                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                color: white;
                                                border: none;
                                                border-radius: 6px;
                                                cursor: pointer;
                                                font-weight: 600;
                                                font-size: 16px;
                                                transition: all 0.3s ease;
                                            ">
                                                <i class="fas fa-sync-alt"></i> Convert to Template
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Output Panel -->
                                    <div class="tt-panel" style="
                                        background: white;
                                        border-radius: 10px;
                                        padding: 25px;
                                        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
                                        border: 1px solid #e2e8f0;
                                    ">
                                        <div class="tt-panel-header" style="
                                            display: flex;
                                            align-items: center;
                                            margin-bottom: 20px;
                                            padding-bottom: 15px;
                                            border-bottom: 2px solid #f7fafc;
                                        ">
                                            <i class="fas fa-file-code" style="
                                                font-size: 1.5em;
                                                margin-right: 10px;
                                                color: #667eea;
                                            "></i>
                                            <h2 style="margin: 0; color: #2d3748;">Generated Template</h2>
                                        </div>
                                        
                                        <!-- Output Display -->
                                        <div class="tt-output-container" ${!this.state.output ? 'style="display: none;"' : ''}>
                                            <pre class="tt-output" style="
                                                width: 100%;
                                                min-height: 300px;
                                                max-height: 500px;
                                                padding: 15px;
                                                border: 2px solid #e2e8f0;
                                                border-radius: 6px;
                                                font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                                                font-size: 12px;
                                                background: #1e1e1e;
                                                color: #d4d4d4;
                                                overflow: auto;
                                                white-space: pre-wrap;
                                                word-wrap: break-word;
                                                margin: 0 0 20px 0;
                                            ">${this.highlightXML(this.state.output)}</pre>
                                            
                                            <!-- Action Buttons -->
                                            <div class="tt-actions" style="
                                                display: flex;
                                                gap: 10px;
                                                flex-wrap: wrap;
                                            ">
                                                <button class="tt-copy-btn" style="
                                                    padding: 10px 20px;
                                                    background: #38a169;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 6px;
                                                    cursor: pointer;
                                                    font-weight: 600;
                                                    transition: background 0.3s ease;
                                                ">
                                                    <i class="far fa-copy"></i> Copy XML
                                                </button>
                                                <button class="tt-save-btn" style="
                                                    padding: 10px 20px;
                                                    background: #667eea;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 6px;
                                                    cursor: pointer;
                                                    font-weight: 600;
                                                    transition: background 0.3s ease;
                                                ">
                                                    <i class="fas fa-rocket"></i> Save & Deploy
                                                </button>
                                                <button class="tt-download-btn" style="
                                                    padding: 10px 20px;
                                                    background: #ed8936;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 6px;
                                                    cursor: pointer;
                                                    font-weight: 600;
                                                    transition: background 0.3s ease;
                                                ">
                                                    <i class="fas fa-download"></i> Download XML
                                                </button>
                                                <button class="tt-clear-btn" style="
                                                    padding: 10px 20px;
                                                    background: #e53e3e;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 6px;
                                                    cursor: pointer;
                                                    font-weight: 600;
                                                    transition: background 0.3s ease;
                                                ">
                                                    <i class="fas fa-trash"></i> Clear
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Placeholder -->
                                        <div class="tt-placeholder" ${this.state.output ? 'style="display: none;"' : ''} style="
                                            text-align: center;
                                            padding: 60px 20px;
                                            color: #a0aec0;
                                        ">
                                            <i class="fas fa-arrow-left" style="
                                                font-size: 3em;
                                                margin-bottom: 20px;
                                                color: #cbd5e0;
                                            "></i>
                                            <h3 style="margin: 0 0 10px 0; color: #718096;">Ready to Convert</h3>
                                            <p>Paste your Docker configuration on the left and click "Convert to Template"</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Examples Section -->
                                <div class="tt-examples" style="
                                    background: #f7fafc;
                                    border-radius: 10px;
                                    padding: 25px;
                                    border: 1px solid #e2e8f0;
                                    margin-bottom: 30px;
                                ">
                                    <h3 style="margin: 0 0 20px 0; color: #2d3748;">
                                        <i class="fas fa-lightbulb"></i> Quick Examples
                                    </h3>
                                    <p style="margin: 0 0 15px 0; color: #4a5568;">
                                        Try these examples or paste your own configuration:
                                    </p>
                                    
                                    <div class="tt-example-tabs" style="
                                        display: flex;
                                        gap: 10px;
                                        margin-bottom: 20px;
                                        flex-wrap: wrap;
                                    ">
                                        <button class="tt-example-tab active" data-example="docker-run" style="
                                            padding: 8px 16px;
                                            background: #667eea;
                                            color: white;
                                            border: none;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-weight: 500;
                                            transition: background 0.3s ease;
                                        ">Basic Docker Run</button>
                                        <button class="tt-example-tab" data-example="docker-compose" style="
                                            padding: 8px 16px;
                                            background: #e2e8f0;
                                            color: #4a5568;
                                            border: none;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-weight: 500;
                                            transition: background 0.3s ease;
                                        ">Docker Compose</button>
                                        <button class="tt-example-tab" data-example="gpu" style="
                                            padding: 8px 16px;
                                            background: #e2e8f0;
                                            color: #4a5568;
                                            border: none;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-weight: 500;
                                            transition: background 0.3s ease;
                                        ">NVIDIA GPU</button>
                                        <button class="tt-example-tab" data-example="plex" style="
                                            padding: 8px 16px;
                                            background: #e2e8f0;
                                            color: #4a5568;
                                            border: none;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-weight: 500;
                                            transition: background 0.3s ease;
                                        ">Plex Media Server</button>
                                    </div>
                                    
                                    <pre class="tt-example-code" style="
                                        background: #1e1e1e;
                                        color: #d4d4d4;
                                        padding: 20px;
                                        border-radius: 6px;
                                        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                                        font-size: 13px;
                                        overflow: auto;
                                        max-height: 300px;
                                        margin: 0;
                                        cursor: pointer;
                                        transition: opacity 0.3s ease;
                                    ">${this.getExampleCode('docker-run')}</pre>
                                </div>
                                
                                <!-- Status Messages -->
                                <div class="tt-messages" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
                                    ${this.state.error ? `
                                        <div class="tt-error" style="
                                            background: #fed7d7;
                                            color: #742a2a;
                                            padding: 15px 25px;
                                            border-radius: 6px;
                                            margin-bottom: 10px;
                                            border-left: 4px solid #e53e3e;
                                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                            animation: slideIn 0.3s ease;
                                        ">
                                            <i class="fas fa-exclamation-circle"></i> ${this.state.error}
                                        </div>
                                    ` : ''}
                                    
                                    ${this.state.success ? `
                                        <div class="tt-success" style="
                                            background: #c6f6d5;
                                            color: #22543d;
                                            padding: 15px 25px;
                                            border-radius: 6px;
                                            margin-bottom: 10px;
                                            border-left: 4px solid #38a169;
                                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                            animation: slideIn 0.3s ease;
                                        ">
                                            <i class="fas fa-check-circle"></i> ${this.state.success}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Loading Overlay -->
                                <div class="tt-loading" ${!this.state.isLoading ? 'style="display: none;"' : ''} style="
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0,0,0,0.85);
                                    z-index: 9999;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-direction: column;
                                ">
                                    <div class="tt-radar" style="
                                        position: relative;
                                        width: 200px;
                                        height: 200px;
                                        margin-bottom: 30px;
                                    ">
                                        <div class="tt-radar-scan" style="
                                            width: 100%;
                                            height: 100%;
                                            border-radius: 50%;
                                            background: conic-gradient(
                                                from 0deg,
                                                transparent 0deg,
                                                rgba(102, 126, 234, 0.6) 90deg,
                                                transparent 180deg,
                                                transparent 360deg
                                            );
                                            animation: radarRotate 2s linear infinite;
                                        "></div>
                                        <div class="tt-radar-center" style="
                                            position: absolute;
                                            top: 50%;
                                            left: 50%;
                                            transform: translate(-50%, -50%);
                                            width: 30px;
                                            height: 30px;
                                            background: rgba(102, 126, 234, 0.8);
                                            border-radius: 50%;
                                            box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
                                        "></div>
                                    </div>
                                    <div class="tt-loading-text" style="
                                        color: white;
                                        font-size: 1.2em;
                                        text-align: center;
                                    ">Processing your request...</div>
                                </div>
                            </div>
                            
                            <style>
                                @keyframes slideIn {
                                    from {
                                        transform: translateX(100%);
                                        opacity: 0;
                                    }
                                    to {
                                        transform: translateX(0);
                                        opacity: 1;
                                    }
                                }
                                
                                @keyframes radarRotate {
                                    0% { transform: rotate(0deg); }
                                    100% { transform: rotate(360deg); }
                                }
                                
                                .tt-format-btn:hover:not(.active) {
                                    border-color: #667eea !important;
                                    background: #e9d8fd !important;
                                }
                                
                                .tt-input:focus {
                                    outline: none;
                                    border-color: #667eea !important;
                                    background: white !important;
                                }
                                
                                .tt-template-name:focus {
                                    outline: none;
                                    border-color: #667eea !important;
                                }
                                
                                .tt-convert-btn:hover {
                                    transform: translateY(-2px);
                                    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4) !important;
                                }
                                
                                .tt-example-tab:hover:not(.active) {
                                    background: #cbd5e0 !important;
                                }
                                
                                .tt-example-code:hover {
                                    opacity: 0.9;
                                }
                                
                                .tt-copy-btn:hover { background: #2f855a !important; }
                                .tt-save-btn:hover { background: #5a67d8 !important; }
                                .tt-download-btn:hover { background: #dd6b20 !important; }
                                .tt-clear-btn:hover { background: #c53030 !important; }
                                
                                @media (max-width: 1024px) {
                                    .tt-grid {
                                        grid-template-columns: 1fr !important;
                                    }
                                    
                                    .tt-header h1 {
                                        font-size: 2em !important;
                                    }
                                    
                                    .tt-controls {
                                        flex-direction: column !important;
                                    }
                                    
                                    .tt-actions {
                                        flex-direction: column !important;
                                    }
                                }
                            </style>
                        `;
                    },
                    
                    // Bind event listeners
                    bindEvents: function() {
                        // Format selector
                        appContainer.querySelectorAll('.tt-format-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const format = e.target.dataset.format;
                                this.setFormat(format);
                            });
                        });
                        
                        // Example tabs
                        appContainer.querySelectorAll('.tt-example-tab').forEach(tab => {
                            tab.addEventListener('click', (e) => {
                                const example = e.target.dataset.example;
                                this.showExample(example);
                            });
                        });
                        
                        // Example code click to copy
                        const exampleCode = appContainer.querySelector('.tt-example-code');
                        if (exampleCode) {
                            exampleCode.addEventListener('click', () => {
                                this.state.input = exampleCode.textContent;
                                this.updateInput();
                            });
                        }
                        
                        // Convert button
                        const convertBtn = appContainer.querySelector('.tt-convert-btn');
                        if (convertBtn) {
                            convertBtn.addEventListener('click', () => this.convert());
                        }
                        
                        // Copy button
                        const copyBtn = appContainer.querySelector('.tt-copy-btn');
                        if (copyBtn) {
                            copyBtn.addEventListener('click', () => this.copyOutput());
                        }
                        
                        // Save button
                        const saveBtn = appContainer.querySelector('.tt-save-btn');
                        if (saveBtn) {
                            saveBtn.addEventListener('click', () => this.saveTemplate());
                        }
                        
                        // Download button
                        const downloadBtn = appContainer.querySelector('.tt-download-btn');
                        if (downloadBtn) {
                            downloadBtn.addEventListener('click', () => this.downloadTemplate());
                        }
                        
                        // Clear button
                        const clearBtn = appContainer.querySelector('.tt-clear-btn');
                        if (clearBtn) {
                            clearBtn.addEventListener('click', () => this.clearAll());
                        }
                        
                        // Enter key in template name
                        const templateName = appContainer.querySelector('.tt-template-name');
                        if (templateName) {
                            templateName.addEventListener('keypress', (e) => {
                                if (e.key === 'Enter') {
                                    this.convert();
                                }
                            });
                        }
                        
                        // Auto-save input changes
                        const textarea = appContainer.querySelector('.tt-input');
                        if (textarea) {
                            textarea.addEventListener('input', (e) => {
                                this.state.input = e.target.value;
                                this.saveToStorage();
                            });
                        }
                    },
                    
                    // Update UI methods
                    updateInput: function() {
                        const textarea = appContainer.querySelector('.tt-input');
                        if (textarea) {
                            textarea.value = this.state.input;
                        }
                    },
                    
                    updateOutput: function() {
                        const outputContainer = appContainer.querySelector('.tt-output-container');
                        const placeholder = appContainer.querySelector('.tt-placeholder');
                        const output = appContainer.querySelector('.tt-output');
                        
                        if (output) {
                            output.innerHTML = this.highlightXML(this.state.output);
                        }
                        
                        if (this.state.output) {
                            if (outputContainer) outputContainer.style.display = 'block';
                            if (placeholder) placeholder.style.display = 'none';
                        } else {
                            if (outputContainer) outputContainer.style.display = 'none';
                            if (placeholder) placeholder.style.display = 'block';
                        }
                    },
                    
                    updateExamplesUI: function() {
                        const exampleTabs = appContainer.querySelectorAll('.tt-example-tab');
                        exampleTabs.forEach(tab => {
                            if (this.state.examples[tab.dataset.example]) {
                                tab.style.display = 'inline-block';
                            } else {
                                tab.style.display = 'none';
                            }
                        });
                    },
                    
                    // Core functionality
                    setFormat: function(format) {
                        this.state.format = format;
                        
                        // Update UI
                        appContainer.querySelectorAll('.tt-format-btn').forEach(btn => {
                            const isActive = btn.dataset.format === format;
                            btn.classList.toggle('active', isActive);
                            btn.style.background = isActive ? '#667eea' : '#f7fafc';
                            btn.style.color = isActive ? 'white' : '#4a5568';
                            btn.style.borderColor = isActive ? '#667eea' : '#e2e8f0';
                        });
                        
                        // Update placeholder
                        const textarea = appContainer.querySelector('.tt-input');
                        if (textarea) {
                            textarea.placeholder = format === 'docker-run' 
                                ? 'Paste your docker run command here...\n\nExample:\ndocker run -d --name=myapp -p 8080:80 nginx:alpine'
                                : 'Paste your docker-compose.yml here...\n\nExample:\nversion: "3"\nservices:\n  myapp:\n    image: nginx:alpine\n    ports:\n      - "8080:80"';
                        }
                    },
                    
                    showExample: function(exampleKey) {
                        // Update active tab
                        appContainer.querySelectorAll('.tt-example-tab').forEach(tab => {
                            const isActive = tab.dataset.example === exampleKey;
                            tab.classList.toggle('active', isActive);
                            tab.style.background = isActive ? '#667eea' : '#e2e8f0';
                            tab.style.color = isActive ? 'white' : '#4a5568';
                        });
                        
                        // Update example code display
                        const exampleCode = appContainer.querySelector('.tt-example-code');
                        if (exampleCode) {
                            exampleCode.textContent = this.getExampleCode(exampleKey);
                        }
                    },
                    
                    getExampleCode: function(key) {
                        if (this.state.examples[key]) {
                            return this.state.examples[key].code;
                        }
                        
                        // Default examples
                        const defaults = {
                            'docker-run': `docker run -d \\
  --name=myapp \\
  --restart=unless-stopped \\
  -e TZ=America/New_York \\
  -p 8080:80 \\
  -v /mnt/user/appdata/myapp:/config \\
  nginx:alpine`,
                            'docker-compose': `version: '3'
services:
  myapp:
    image: nginx:alpine
    container_name: myapp
    environment:
      - TZ=America/New_York
    volumes:
      - /mnt/user/appdata/myapp:/usr/share/nginx/html
    ports:
      - "8080:80"
    restart: unless-stopped`,
                            'gpu': `docker run -d \\
  --name=nvidia-test \\
  --gpus all \\
  --runtime=nvidia \\
  -e NVIDIA_VISIBLE_DEVICES=all \\
  nvidia/cuda:12.2.0-base-ubuntu22.04 \\
  nvidia-smi`,
                            'plex': `docker run -d \\
  --name=plex \\
  --network=host \\
  -e TZ=America/New_York \\
  -e PLEX_CLAIM=claim-your-token-here \\
  -v /mnt/user/appdata/plex:/config \\
  -v /mnt/user/media:/data \\
  plexinc/pms-docker:latest`
                        };
                        
                        return defaults[key] || defaults['docker-run'];
                    },
                    
                    convert: async function() {
                        const input = appContainer.querySelector('.tt-input')?.value.trim() || this.state.input;
                        const templateName = appContainer.querySelector('.tt-template-name')?.value || this.state.templateName;
                        
                        if (!input) {
                            this.showError('Please paste a Docker command or compose file');
                            return;
                        }
                        
                        this.setState({ isLoading: true, error: null, success: null });
                        
                        try {
                            const response = await fetch(API_BASE, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'convert',
                                    input: input,
                                    type: this.state.format,
                                    templateName: templateName
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                this.setState({
                                    output: data.data.xml,
                                    success: 'Conversion successful!'
                                });
                                this.updateOutput();
                            } else {
                                this.showError(data.error || 'Conversion failed');
                            }
                        } catch (error) {
                            this.showError('Network error: ' + error.message);
                        } finally {
                            this.setState({ isLoading: false });
                        }
                    },
                    
                    copyOutput: function() {
                        if (!this.state.output) return;
                        
                        navigator.clipboard.writeText(this.state.output)
                            .then(() => this.showSuccess('XML copied to clipboard!'))
                            .catch(err => this.showError('Failed to copy: ' + err.message));
                    },
                    
                    saveTemplate: async function() {
                        if (!this.state.output) {
                            this.showError('No template to save');
                            return;
                        }
                        
                        const templateName = appContainer.querySelector('.tt-template-name')?.value || this.state.templateName;
                        const safeName = templateName.toLowerCase()
                            .replace(/[^a-z0-9]/g, '-')
                            .replace(/-+/g, '-')
                            .replace(/^-|-$/g, '');
                        
                        this.setState({ isLoading: true, error: null });
                        
                        try {
                            const response = await fetch(API_BASE, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'save',
                                    xml: this.state.output,
                                    name: safeName
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                this.showSuccess('Template saved successfully! Redirecting...');
                                setTimeout(() => {
                                    if (data.redirect) {
                                        window.location.href = data.redirect;
                                    } else {
                                        window.location.href = '/Docker';
                                    }
                                }, 1500);
                            } else {
                                this.showError(data.error || 'Save failed');
                            }
                        } catch (error) {
                            this.showError('Network error: ' + error.message);
                        } finally {
                            this.setState({ isLoading: false });
                        }
                    },
                    
                    downloadTemplate: function() {
                        if (!this.state.output) {
                            this.showError('No template to download');
                            return;
                        }
                        
                        const templateName = appContainer.querySelector('.tt-template-name')?.value || this.state.templateName;
                        const safeName = templateName.toLowerCase()
                            .replace(/[^a-z0-9]/g, '-')
                            .replace(/-+/g, '-')
                            .replace(/^-|-$/g, '');
                        
                        const blob = new Blob([this.state.output], { type: 'application/xml' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${safeName}.xml`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        this.showSuccess('Template downloaded!');
                    },
                    
                    clearAll: function() {
                        this.setState({
                            input: '',
                            output: '',
                            error: null,
                            success: null
                        });
                        this.updateInput();
                        this.updateOutput();
                        this.showSuccess('Cleared');
                    },
                    
                    // Helper methods
                    setState: function(newState) {
                        Object.assign(this.state, newState);
                        this.saveToStorage();
                        this.updateLoadingState();
                        this.updateMessages();
                    },
                    
                    updateLoadingState: function() {
                        const loading = appContainer.querySelector('.tt-loading');
                        if (loading) {
                            loading.style.display = this.state.isLoading ? 'flex' : 'none';
                        }
                    },
                    
                    updateMessages: function() {
                        // Messages auto-clear after 5 seconds
                        if (this.state.error) {
                            setTimeout(() => {
                                if (this.state.error) {
                                    this.setState({ error: null });
                                }
                            }, 5000);
                        }
                        
                        if (this.state.success) {
                            setTimeout(() => {
                                if (this.state.success) {
                                    this.setState({ success: null });
                                }
                            }, 5000);
                        }
                    },
                    
                    showError: function(message) {
                        this.setState({ error: message, success: null });
                    },
                    
                    showSuccess: function(message) {
                        this.setState({ success: message, error: null });
                    },
                    
                    highlightXML: function(xml) {
                        if (!xml) return '';
                        return xml
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/("(?:[^"]|"")*")/g, '<span style="color: #ce9178;">$1</span>')
                            .replace(/(&lt;\/?)(\w+)/g, '$1<span style="color: #569cd6;">$2</span>')
                            .replace(/(\s\w+=)/g, '<span style="color: #9cdcfe;">$1</span>')
                            .replace(/&lt;!--[\s\S]*?--&gt;/g, '<span style="color: #6a9955;">$&</span>');
                    },
                    
                    saveToStorage: function() {
                        try {
                            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                                input: this.state.input,
                                format: this.state.format,
                                templateName: this.state.templateName
                            }));
                        } catch (e) {
                            // Storage may be unavailable
                        }
                    },
                    
                    loadFromStorage: function() {
                        try {
                            const saved = localStorage.getItem(STORAGE_KEY);
                            if (saved) {
                                const data = JSON.parse(saved);
                                Object.assign(this.state, data);
                            }
                        } catch (e) {
                            // Ignore storage errors
                        }
                    },
                    
                    checkCompatibility: async function() {
                        try {
                            const response = await fetch(`${API_BASE}?action=status`);
                            const data = await response.json();
                            
                            if (!data.compatible) {
                                this.showError('Plugin may not be fully compatible with your Unraid version');
                            }
                        } catch (error) {
                            // Silently fail compatibility check
                        }
                    }
                };
                
                // Initialize and return
                app.loadFromStorage();
                app.init();
                return app;
            }
        };
    }
    
    // Integration with Unraid's React app
    function integrateWithUnraid() {
        if (typeof window.unraid !== 'undefined' && window.unraid.app) {
            // Register as a Unraid plugin
            window.unraid.app.registerPlugin('templateTools', {
                name: 'Template Tools',
                version: VERSION,
                icon: 'fa-magic',
                category: 'Docker',
                
                onActivate: function() {
                    // Create button in Docker toolbar
                    const toolbar = document.querySelector('.docker-toolbar, .toolbar');
                    if (toolbar) {
                        const button = document.createElement('button');
                        button.className = 'unraid-button template-tools-button';
                        button.innerHTML = '<i class="fas fa-magic"></i> Template Tools';
                        button.onclick = openTemplateTools;
                        toolbar.appendChild(button);
                    }
                },
                
                onDeactivate: function() {
                    // Clean up
                    const button = document.querySelector('.template-tools-button');
                    if (button) button.remove();
                }
            });
            
            console.log('Template Tools integrated with Unraid React app');
        }
    }
    
    // Open template tools in modal
    function openTemplateTools() {
        // Create modal container
        const modal = document.createElement('div');
        modal.className = 'template-tools-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="
                width: 90%;
                max-width: 1400px;
                height: 90vh;
                background: white;
                border-radius: 12px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            ">
                <div style="
                    padding: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <h2 style="margin: 0;">
                        <i class="fas fa-magic"></i> Docker Template Converter
                    </h2>
                    <button class="close-modal" style="
                        background: none;
                        border: none;
                        color: white;
                        font-size: 24px;
                        cursor: pointer;
                        padding: 0;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background 0.3s;
                    "></button>
                </div>
                <div style="flex: 1; overflow: hidden;">
                    <iframe src="/plugins/templateTools/include/dockerConverter.php" 
                            style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
        `;
        
        // Add to document
        document.body.appendChild(modal);
        
        // Close button
        modal.querySelector('.close-modal').onclick = () => modal.remove();
        
        // Close on escape
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') modal.remove();
        });
        
        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
        
        // Focus modal
        modal.focus();
    }
    
    // Initialize when DOM is ready
    function init() {
        // Check if we're in Unraid React app
        if (document.body.hasAttribute('data-reactroot') || 
            document.querySelector('#root') || 
            typeof window.unraid !== 'undefined') {
            
            // Integrate with Unraid
            integrateWithUnraid();
            
            // Also create global access
            window.TemplateToolsReact = {
                createApp: createTemplateToolsApp,
                open: openTemplateTools,
                version: VERSION
            };
            
            console.log(`Template Tools React v${VERSION} initialized`);
        }
    }
    
    // Export public API
    return {
        init,
        createTemplateToolsApp,
        integrateWithUnraid,
        openTemplateTools,
        version: VERSION
    };
})();

// Auto-initialize
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', TemplateToolsReact.init);
} else {
    TemplateToolsReact.init();
}

// Export for ES6 modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = TemplateToolsReact;
}

// Global access
window.TemplateTools = TemplateToolsReact;]]>
    </FILE>
    
    <!-- Modern CSS for React App -->
    <FILE name="/usr/local/emhttp/plugins/templateTools/css/templateTools-react.css" method="install">
<![CDATA[/**
 * Template Tools React CSS for Unraid 7.2.3+
 * Modern, responsive styling for React components
 */

/* CSS Variables for theming */
:root {
  --tt-primary: #667eea;
  --tt-secondary: #764ba2;
  --tt-success: #38a169;
  --tt-warning: #ed8936;
  --tt-danger: #e53e3e;
  --tt-info: #4299e1;
  --tt-dark: #2d3748;
  --tt-light: #f7fafc;
  --tt-gray: #a0aec0;
  --tt-border: #e2e8f0;
  --tt-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  --tt-radius: 10px;
  --tt-transition: all 0.3s ease;
}

/* Base Styles */
.template-tools-container {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  color: var(--tt-dark);
  background: var(--tt-light);
  min-height: 100vh;
}

/* Typography */
.tt-heading-1 {
  font-size: 2.5em;
  font-weight: 700;
  margin: 0 0 0.5em 0;
  background: linear-gradient(135deg, var(--tt-primary), var(--tt-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.tt-heading-2 {
  font-size: 1.75em;
  font-weight: 600;
  margin: 0 0 0.75em 0;
  color: var(--tt-dark);
}

.tt-heading-3 {
  font-size: 1.25em;
  font-weight: 600;
  margin: 0 0 0.5em 0;
  color: var(--tt-dark);
}

.tt-text {
  font-size: 1em;
  line-height: 1.6;
  color: var(--tt-dark);
  opacity: 0.9;
}

/* Layout Components */
.tt-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 30px;
  margin: 30px 0;
}

.tt-panel {
  background: white;
  border-radius: var(--tt-radius);
  padding: 25px;
  box-shadow: var(--tt-shadow);
  border: 1px solid var(--tt-border);
  transition: var(--tt-transition);
}

.tt-panel:hover {
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
}

.tt-panel-header {
  display: flex;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--tt-light);
}

.tt-panel-header i {
  font-size: 1.5em;
  margin-right: 12px;
  color: var(--tt-primary);
}

/* Form Elements */
.tt-input {
  width: 100%;
  min-height: 300px;
  padding: 20px;
  border: 2px solid var(--tt-border);
  border-radius: 8px;
  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
  font-size: 14px;
  line-height: 1.5;
  resize: vertical;
  background: #fafafa;
  transition: var(--tt-transition);
}

.tt-input:focus {
  outline: none;
  border-color: var(--tt-primary);
  background: white;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.tt-textfield {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--tt-border);
  border-radius: 8px;
  font-size: 16px;
  transition: var(--tt-transition);
}

.tt-textfield:focus {
  outline: none;
  border-color: var(--tt-primary);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Buttons */
.tt-button {
  padding: 12px 28px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  transition: var(--tt-transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.tt-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.tt-button-primary {
  background: linear-gradient(135deg, var(--tt-primary), var(--tt-secondary));
  color: white;
}

.tt-button-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
}

.tt-button-secondary {
  background: var(--tt-light);
  color: var(--tt-dark);
  border: 2px solid var(--tt-border);
}

.tt-button-secondary:hover:not(:disabled) {
  background: #e2e8f0;
  border-color: var(--tt-primary);
}

.tt-button-success {
  background: var(--tt-success);
  color: white;
}

.tt-button-warning {
  background: var(--tt-warning);
  color: white;
}

.tt-button-danger {
  background: var(--tt-danger);
  color: white;
}

.tt-button-info {
  background: var(--tt-info);
  color: white;
}

/* Format Selector */
.tt-format-selector {
  display: flex;
  gap: 10px;
  margin-bottom: 25px;
}

.tt-format-button {
  flex: 1;
  padding: 15px;
  background: var(--tt-light);
  border: 2px solid var(--tt-border);
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  text-align: center;
  transition: var(--tt-transition);
}

.tt-format-button:hover {
  border-color: var(--tt-primary);
  background: #e9d8fd;
}

.tt-format-button.active {
  background: linear-gradient(135deg, var(--tt-primary), var(--tt-secondary));
  color: white;
  border-color: var(--tt-primary);
}

/* Output Display */
.tt-output-container {
  background: #1e1e1e;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 25px;
}

.tt-output {
  padding: 20px;
  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
  font-size: 13px;
  line-height: 1.6;
  color: #d4d4d4;
  overflow: auto;
  max-height: 500px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* XML Syntax Highlighting */
.tt-xml-tag { color: #569cd6; }
.tt-xml-attr { color: #9cdcfe; }
.tt-xml-value { color: #ce9178; }
.tt-xml-comment { color: #6a9955; font-style: italic; }
.tt-xml-text { color: #d4d4d4; }

/* Action Buttons */
.tt-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.tt-action-button {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--tt-transition);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.tt-action-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* Examples Section */
.tt-examples {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-radius: var(--tt-radius);
  padding: 30px;
  margin: 40px 0;
}

.tt-example-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.tt-example-tab {
  padding: 10px 20px;
  background: rgba(255, 255, 255, 0.8);
  border: 2px solid transparent;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: var(--tt-transition);
}

.tt-example-tab:hover {
  background: white;
  border-color: var(--tt-primary);
}

.tt-example-tab.active {
  background: linear-gradient(135deg, var(--tt-primary), var(--tt-secondary));
  color: white;
  border-color: var(--tt-primary);
}

.tt-example-code {
  background: #2d3748;
  color: #e2e8f0;
  padding: 25px;
  border-radius: 8px;
  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
  font-size: 14px;
  line-height: 1.6;
  overflow: auto;
  max-height: 400px;
  cursor: pointer;
  transition: var(--tt-transition);
}

.tt-example-code:hover {
  background: #1a202c;
}

/* Loading Overlay */
.tt-loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}

/* Radar Animation */
.tt-radar-container {
  position: relative;
  width: 200px;
  height: 200px;
  margin-bottom: 40px;
}

.tt-radar-scan {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: conic-gradient(
    from 0deg,
    transparent 0deg,
    rgba(102, 126, 234, 0.6) 90deg,
    transparent 180deg,
    transparent 360deg
  );
  animation: radar-rotate 2s linear infinite;
}

.tt-radar-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 30px;
  height: 30px;
  background: rgba(102, 126, 234, 0.8);
  border-radius: 50%;
  box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
}

@keyframes radar-rotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.tt-loading-text {
  color: white;
  font-size: 1.2em;
  text-align: center;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Notifications */
.tt-notification {
  position: fixed;
  bottom: 30px;
  right: 30px;
  padding: 20px 30px;
  border-radius: 8px;
  color: white;
  font-weight: 500;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  z-index: 1000;
  animation: slide-in 0.3s ease;
  max-width: 400px;
}

.tt-notification-success {
  background: linear-gradient(135deg, #38a169, #2f855a);
  border-left: 4px solid #276749;
}

.tt-notification-error {
  background: linear-gradient(135deg, #e53e3e, #c53030);
  border-left: 4px solid #9b2c2c;
}

.tt-notification-info {
  background: linear-gradient(135deg, #4299e1, #3182ce);
  border-left: 4px solid #2c5282;
}

@keyframes slide-in {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Responsive Design */
@media (max-width: 1024px) {
  .tt-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .tt-heading-1 {
    font-size: 2em;
  }
  
  .tt-heading-2 {
    font-size: 1.5em;
  }
  
  .tt-panel {
    padding: 20px;
  }
  
  .tt-actions {
    flex-direction: column;
  }
  
  .tt-action-button {
    width: 100%;
  }
  
  .tt-notification {
    left: 20px;
    right: 20px;
    max-width: none;
  }
}

@media (max-width: 640px) {
  .tt-format-selector {
    flex-direction: column;
  }
  
  .tt-example-tabs {
    flex-direction: column;
  }
  
  .tt-example-tab {
    width: 100%;
  }
  
  .tt-button {
    width: 100%;
    padding: 15px;
  }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
  .tt-panel {
    background: #2d3748;
    border-color: #4a5568;
    color: #e2e8f0;
  }
  
  .tt-input, .tt-textfield {
    background: #1a202c;
    border-color: #4a5568;
    color: #e2e8f0;
  }
  
  .tt-input:focus, .tt-textfield:focus {
    background: #2d3748;
  }
  
  .tt-format-button {
    background: #4a5568;
    border-color: #718096;
    color: #e2e8f0;
  }
  
  .tt-examples {
    background: #4a5568;
  }
  
  .tt-example-tab {
    background: #2d3748;
    color: #e2e8f0;
  }
}

/* Print Styles */
@media print {
  .tt-actions,
  .tt-examples,
  .tt-format-selector,
  .tt-loading-overlay,
  .tt-notification {
    display: none !important;
  }
  
  .tt-panel {
    box-shadow: none !important;
    border: 1px solid #ccc !important;
  }
  
  .tt-output {
    max-height: none !important;
  }
}

/* Accessibility Improvements */
.tt-button:focus,
.tt-format-button:focus,
.tt-textfield:focus,
.tt-input:focus {
  outline: 2px solid var(--tt-primary);
  outline-offset: 2px;
}

/* Custom Scrollbars */
.tt-output::-webkit-scrollbar,
.tt-example-code::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

.tt-output::-webkit-scrollbar-track,
.tt-example-code::-webkit-scrollbar-track {
  background: #2d3748;
}

.tt-output::-webkit-scrollbar-thumb,
.tt-example-code::-webkit-scrollbar-thumb {
  background: #4a5568;
  border-radius: 5px;
}

.tt-output::-webkit-scrollbar-thumb:hover,
.tt-example-code::-webkit-scrollbar-thumb:hover {
  background: #718096;
}

/* Utility Classes */
.tt-text-center { text-align: center; }
.tt-text-right { text-align: right; }
.tt-mt-1 { margin-top: 0.5em; }
.tt-mt-2 { margin-top: 1em; }
.tt-mt-3 { margin-top: 1.5em; }
.tt-mt-4 { margin-top: 2em; }
.tt-mb-1 { margin-bottom: 0.5em; }
.tt-mb-2 { margin-bottom: 1em; }
.tt-mb-3 { margin-bottom: 1.5em; }
.tt-mb-4 { margin-bottom: 2em; }
.tt-hidden { display: none; }
.tt-visible { display: block; }
.tt-flex { display: flex; }
.tt-flex-col { flex-direction: column; }
.tt-items-center { align-items: center; }
.tt-justify-center { justify-content: center; }
.tt-gap-1 { gap: 0.5em; }
.tt-gap-2 { gap: 1em; }
.tt-gap-3 { gap: 1.5em; }
.tt-w-full { width: 100%; }
.tt-h-full { height: 100%; }]]>
    </FILE>
    
    <!-- Updated Install Script for Unraid 7 -->
    <FILE name="/usr/local/emhttp/plugins/templateTools/scripts/install" method="install" mode="0755">
<![CDATA[#!/bin/bash
# Template Tools Plugin Install Script for Unraid 7.2.3+

PLUGIN_NAME="templateTools"
PLUGIN_DIR="/usr/local/emhttp/plugins/$PLUGIN_NAME"
CONFIG_DIR="/boot/config/plugins/$PLUGIN_NAME"
TEMPLATE_DIR="/boot/config/plugins/dockerMan/templates-user"
LOG_FILE="/var/log/${PLUGIN_NAME}-install.log"
UNRAID_VERSION_FILE="/etc/unraid-version"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Check Unraid version
check_unraid_version() {
    if [[ ! -f "$UNRAID_VERSION_FILE" ]]; then
        log_error "Cannot determine Unraid version. File not found: $UNRAID_VERSION_FILE"
        return 1
    fi
    
    UNRAID_VERSION=$(cat "$UNRAID_VERSION_FILE")
    log_info "Detected Unraid version: $UNRAID_VERSION"
    
    # Check if version is 7.2.0 or higher
    if [[ "$UNRAID_VERSION" =~ ^7\.2\.[0-9]+$ ]] || [[ "$UNRAID_VERSION" =~ ^7\.[3-9]\. ]]; then
        log_success "Unraid version $UNRAID_VERSION is supported"
        return 0
    elif [[ "$UNRAID_VERSION" =~ ^7\.[0-1]\. ]]; then
        log_warning "Unraid version $UNRAID_VERSION may have limited compatibility"
        return 0
    else
        log_error "Unraid version $UNRAID_VERSION is not supported. Requires 7.2.0 or higher."
        return 1
    fi
}

# Check Docker availability
check_docker() {
    if ! command -v docker &> /dev/null; then
        log_error "Docker is not installed or not in PATH"
        return 1
    fi
    
    DOCKER_VERSION=$(docker --version | awk '{print $3}' | tr -d ',')
    DOCKER_API_VERSION=$(docker version --format '{{.Server.APIVersion}}' 2>/dev/null || echo "unknown")
    
    log_info "Docker version: $DOCKER_VERSION"
    log_info "Docker API version: $DOCKER_API_VERSION"
    
    # Check Docker API compatibility
    if [[ "$DOCKER_API_VERSION" == "unknown" ]]; then
        log_warning "Could not determine Docker API version"
    elif [[ "$DOCKER_API_VERSION" =~ ^1\.(4[1-9]|[5-9][0-9]|[0-9]{3,}) ]]; then
        log_success "Docker API version $DOCKER_API_VERSION is supported"
    else
        log_warning "Docker API version $DOCKER_API_VERSION may have limited compatibility"
    fi
    
    return 0
}

# Create necessary directories
create_directories() {
    log_info "Creating plugin directories..."
    
    # Plugin directories
    mkdir -p "$PLUGIN_DIR/include" "$PLUGIN_DIR/javascript" "$PLUGIN_DIR/css" "$PLUGIN_DIR/scripts"
    
    # Config directory
    mkdir -p "$CONFIG_DIR"
    
    # Template directory
    mkdir -p "$TEMPLATE_DIR"
    
    # Log directory
    mkdir -p "/var/log"
    
    # Check if directories were created
    if [[ -d "$PLUGIN_DIR" && -d "$CONFIG_DIR" && -d "$TEMPLATE_DIR" ]]; then
        log_success "Directories created successfully"
    else
        log_error "Failed to create directories"
        return 1
    fi
    
    return 0
}

# Set file permissions
set_permissions() {
    log_info "Setting file permissions..."
    
    # Set execute permissions on scripts
    chmod -R 755 "$PLUGIN_DIR/scripts" 2>/dev/null
    
    # Set read permissions on other files
    chmod -R 644 "$PLUGIN_DIR"/*.php 2>/dev/null
    chmod -R 644 "$PLUGIN_DIR/include"/*.php 2>/dev/null
    chmod -R 644 "$PLUGIN_DIR/javascript"/*.js 2>/dev/null
    chmod -R 644 "$PLUGIN_DIR/css"/*.css 2>/dev/null
    
    # Set permissions on config directory
    chmod 755 "$CONFIG_DIR"
    
    # Set permissions on template directory
    chmod 755 "$TEMPLATE_DIR"
    
    log_success "Permissions set"
}

# Check for required PHP modules
check_php_modules() {
    log_info "Checking PHP modules..."
    
    REQUIRED_MODULES=("json" "simplexml" "dom")
    MISSING_MODULES=()
    
    for module in "${REQUIRED_MODULES[@]}"; do
        if php -m | grep -i "^$module$" > /dev/null; then
            log_info "  PHP module $module: OK"
        else
            MISSING_MODULES+=("$module")
            log_warning "  PHP module $module: MISSING"
        fi
    done
    
    if [[ ${#MISSING_MODULES[@]} -gt 0 ]]; then
        log_warning "Some PHP modules are missing: ${MISSING_MODULES[*]}"
        log_warning "Some features may not work correctly"
    else
        log_success "All required PHP modules are available"
    fi
}

# Check appdata directory
check_appdata() {
    log_info "Checking appdata directory..."
    
    APPDATA_PATHS=(
        "/mnt/user/appdata"
        "/mnt/cache/appdata"
        "/mnt/user0/appdata"
    )
    
    APPDATA_FOUND=false
    
    for path in "${APPDATA_PATHS[@]}"; do
        if [[ -d "$path" ]]; then
            log_success "Appdata directory found: $path"
            APPDATA_FOUND=true
            break
        fi
    done
    
    if [[ "$APPDATA_FOUND" == false ]]; then
        log_warning "No appdata directory found. Creating /mnt/user/appdata..."
        mkdir -p "/mnt/user/appdata"
        chmod 777 "/mnt/user/appdata"
        
        if [[ -d "/mnt/user/appdata" ]]; then
            log_success "Appdata directory created: /mnt/user/appdata"
        else
            log_error "Failed to create appdata directory"
        fi
    fi
}

# Test plugin functionality
test_plugin() {
    log_info "Testing plugin functionality..."
    
    # Test PHP syntax
    if php -l "$PLUGIN_DIR/templateTools.php" > /dev/null 2>&1; then
        log_success "Main plugin file syntax: OK"
    else
        log_error "Main plugin file has syntax errors"
        return 1
    fi
    
    # Test converter class
    if php -l "$PLUGIN_DIR/include/class.DockerConverter.php" > /dev/null 2>&1; then
        log_success "Converter class syntax: OK"
    else
        log_error "Converter class has syntax errors"
        return 1
    fi
    
    # Test JavaScript syntax (basic check)
    if node -c "$PLUGIN_DIR/javascript/templateTools-react.js" > /dev/null 2>&1; then
        log_success "React component syntax: OK"
    else
        log_warning "JavaScript syntax check skipped (node not available)"
    fi
    
    # Test API endpoint
    if curl -s "http://localhost/plugins/$PLUGIN_NAME/include/dockerConverter.php?action=status" | grep -q "online"; then
        log_success "API endpoint test: OK"
    else
        log_warning "API endpoint test: Could not verify (web server may not be running)"
    fi
    
    return 0
}

# Create systemd service (for future features)
create_systemd_service() {
    log_info "Creating systemd service (if needed)..."
    
    SERVICE_FILE="/etc/systemd/system/${PLUGIN_NAME}.service"
    
    if [[ ! -f "$SERVICE_FILE" ]]; then
        cat > "$SERVICE_FILE" << EOF
[Unit]
Description=Template Tools Plugin
After=docker.service network.target
Wants=network.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true
ExecReload=/bin/true

[Install]
WantedBy=multi-user.target
EOF
        
        if [[ -f "$SERVICE_FILE" ]]; then
            log_success "Systemd service created"
        else
            log_warning "Failed to create systemd service"
        fi
    else
        log_info "Systemd service already exists"
    fi
}

# Clean up old versions
cleanup_old_versions() {
    log_info "Cleaning up old versions..."
    
    # Remove old JavaScript files if they exist
    OLD_JS_FILES=(
        "$PLUGIN_DIR/javascript/templateTools.js"
        "$PLUGIN_DIR/javascript/templateTools-legacy.js"
    )
    
    for file in "${OLD_JS_FILES[@]}"; do
        if [[ -f "$file" ]]; then
            rm -f "$file"
            log_info "Removed old file: $file"
        fi
    done
    
    # Remove old CSS files
    OLD_CSS_FILES=(
        "$PLUGIN_DIR/css/templateTools.css"
    )
    
    for file in "${OLD_CSS_FILES[@]}"; do
        if [[ -f "$file" ]]; then
            rm -f "$file"
            log_info "Removed old file: $file"
        fi
    done
}

# Main installation process
main() {
    log_info "Starting Template Tools installation for Unraid 7.2.3+"
    
    # Check Unraid version
    if ! check_unraid_version; then
        log_error "Unraid version check failed"
        exit 1
    fi
    
    # Check Docker
    if ! check_docker; then
        log_error "Docker check failed"
        exit 1
    fi
    
    # Create directories
    if ! create_directories; then
        log_error "Failed to create directories"
        exit 1
    fi
    
    # Set permissions
    set_permissions
    
    # Check PHP modules
    check_php_modules
    
    # Check appdata directory
    check_appdata
    
    # Clean up old versions
    cleanup_old_versions
    
    # Test plugin
    if ! test_plugin; then
        log_error "Plugin test failed"
        exit 1
    fi
    
    # Create systemd service
    create_systemd_service
    
    # Finalize
    log_success "========================================="
    log_success "Template Tools Plugin installed successfully!"
    log_success "========================================="
    log_success ""
    log_success "Next steps:"
    log_success "1. Refresh your Unraid web interface (F5)"
    log_success "2. Go to the Docker tab"
    log_success "3. Look for the 'Template Tools' button"
    log_success "4. Click to open the converter"
    log_success ""
    log_success "Plugin directory: $PLUGIN_DIR"
    log_success "Template directory: $TEMPLATE_DIR"
    log_success "Installation log: $LOG_FILE"
    log_success ""
    
    # Create installation marker
    echo "$(date) - Template Tools v2025.01.15 installed on Unraid $UNRAID_VERSION" > "$CONFIG_DIR/installed.txt"
    
    exit 0
}

# Run main function
main "$@"
]]>
    </FILE>
    
    <!-- Updated Uninstall Script for Unraid 7 -->
    <FILE name="/usr/local/emhttp/plugins/templateTools/scripts/uninstall" method="install" mode="0755">
<![CDATA[#!/bin/bash
# Template Tools Plugin Uninstall Script for Unraid 7.2.3+

PLUGIN_NAME="templateTools"
PLUGIN_DIR="/usr/local/emhttp/plugins/$PLUGIN_NAME"
CONFIG_DIR="/boot/config/plugins/$PLUGIN_NAME"
LOG_FILE="/var/log/${PLUGIN_NAME}-uninstall.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Ask for confirmation
ask_confirmation() {
    echo -e "${YELLOW}=========================================${NC}"
    echo -e "${YELLOW} Template Tools Plugin Uninstallation${NC}"
    echo -e "${YELLOW}=========================================${NC}"
    echo ""
    echo -e "This will remove the Template Tools plugin from your system."
    echo ""
    echo -e "${YELLOW}Note:${NC} User-created templates in /boot/config/plugins/dockerMan/templates-user/"
    echo -e "      will NOT be removed automatically."
    echo ""
    
    read -p "Are you sure you want to continue? (y/N): " -n 1 -r
    echo ""
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Uninstallation cancelled by user"
        exit 0
    fi
    
    echo ""
}

# Remove plugin files
remove_plugin_files() {
    log_info "Removing plugin files..."
    
    # Remove plugin directory
    if [[ -d "$PLUGIN_DIR" ]]; then
        rm -rf "$PLUGIN_DIR"
        if [[ ! -d "$PLUGIN_DIR" ]]; then
            log_success "Plugin files removed from $PLUGIN_DIR"
        else
            log_error "Failed to remove plugin directory"
            return 1
        fi
    else
        log_warning "Plugin directory not found: $PLUGIN_DIR"
    fi
    
    # Remove config directory
    if [[ -d "$CONFIG_DIR" ]]; then
        rm -rf "$CONFIG_DIR"
        if [[ ! -d "$CONFIG_DIR" ]]; then
            log_success "Config files removed from $CONFIG_DIR"
        else
            log_error "Failed to remove config directory"
        fi
    else
        log_warning "Config directory not found: $CONFIG_DIR"
    fi
    
    return 0
}

# Remove systemd service
remove_systemd_service() {
    log_info "Removing systemd service..."
    
    SERVICE_FILE="/etc/systemd/system/${PLUGIN_NAME}.service"
    
    if [[ -f "$SERVICE_FILE" ]]; then
        systemctl stop "$PLUGIN_NAME" 2>/dev/null
        systemctl disable "$PLUGIN_NAME" 2>/dev/null
        rm -f "$SERVICE_FILE"
        
        if [[ ! -f "$SERVICE_FILE" ]]; then
            log_success "Systemd service removed"
        else
            log_warning "Failed to remove systemd service file"
        fi
        
        systemctl daemon-reload
    else
        log_info "Systemd service not found"
    fi
}

# Clean up temporary files
cleanup_temporary_files() {
    log_info "Cleaning up temporary files..."
    
    # Remove temporary files
    rm -f "/tmp/${PLUGIN_NAME}"* 2>/dev/null
    rm -f "/var/tmp/${PLUGIN_NAME}"* 2>/dev/null
    
    # Remove socket files if any
    find /tmp -name "*${PLUGIN_NAME}*" -type f -delete 2>/dev/null
    find /var/tmp -name "*${PLUGIN_NAME}*" -type f -delete 2>/dev/null
    
    log_success "Temporary files cleaned up"
}

# Check for remaining files
check_remaining_files() {
    log_info "Checking for remaining files..."
    
    REMAINING_FILES=$(find /usr/local/emhttp/plugins /boot/config/plugins -name "*${PLUGIN_NAME}*" -type f 2>/dev/null)
    
    if [[ -n "$REMAINING_FILES" ]]; then
        log_warning "The following files were not removed:"
        echo "$REMAINING_FILES" | while read -r file; do
            log_warning "  $file"
        done
    else
        log_success "No remaining files found"
    fi
}

# Keep user templates
preserve_user_templates() {
    log_info ""
    log_info "User templates preservation"
    log_info "=========================="
    
    TEMPLATE_DIR="/boot/config/plugins/dockerMan/templates-user"
    
    if [[ -d "$TEMPLATE_DIR" ]]; then
        TEMPLATE_COUNT=$(find "$TEMPLATE_DIR" -name "my-*.xml" -type f | wc -l)
        
        if [[ $TEMPLATE_COUNT -gt 0 ]]; then
            log_info "Found $TEMPLATE_COUNT user template(s) in:"
            log_info "  $TEMPLATE_DIR"
            echo ""
            
            read -p "Do you want to remove these user templates? (y/N): " -n 1 -r
            echo ""
            
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                rm -f "$TEMPLATE_DIR"/my-*.xml
                log_info "User templates removed"
            else
                log_info "User templates preserved"
            fi
        else
            log_info "No user templates found in $TEMPLATE_DIR"
        fi
    else
        log_warning "Template directory not found: $TEMPLATE_DIR"
    fi
}

# Final cleanup
final_cleanup() {
    log_info "Performing final cleanup..."
    
    # Remove log file
    if [[ -f "$LOG_FILE" ]]; then
        rm -f "$LOG_FILE"
    fi
    
    # Clear browser cache hint
    echo ""
    echo -e "${YELLOW}Note:${NC} You may need to clear your browser cache or perform a hard refresh"
    echo -e "      (Ctrl+F5) to completely remove the plugin from the web interface."
    echo ""
}

# Main uninstallation process
main() {
    log_info "Starting Template Tools uninstallation"
    
    # Ask for confirmation
    ask_confirmation
    
    # Remove plugin files
    if ! remove_plugin_files; then
        log_error "Failed to remove plugin files"
        exit 1
    fi
    
    # Remove systemd service
    remove_systemd_service
    
    # Clean up temporary files
    cleanup_temporary_files
    
    # Check for remaining files
    check_remaining_files
    
    # Preserve user templates
    preserve_user_templates
    
    # Final cleanup
    final_cleanup
    
    log_success "========================================="
    log_success "Template Tools Plugin uninstalled successfully!"
    log_success "========================================="
    log_success ""
    log_success "To complete the uninstallation:"
    log_success "1. Refresh your Unraid web interface (F5 or Ctrl+F5)"
    log_success "2. The 'Template Tools' button should disappear"
    log_success ""
    log_success "Thank you for using Template Tools!"
    log_success ""
    
    exit 0
}

# Run main function
main "$@"
]]>
    </FILE>
  
  </FILES>
  
  <SCRIPTS>
    <FILE name="/usr/local/emhttp/plugins/templateTools/scripts/install"
          method="execute" 
          mode="0755"/>
    
    <FILE name="/usr/local/emhttp/plugins/templateTools/scripts/uninstall"
          method="execute"
          mode="0755"/>
  </SCRIPTS>
  
  <PERMS>
    <FILE name="/boot/config/plugins/templateTools/"
          mode="0755"/>
    
    <FILE name="/boot/config/plugins/dockerMan/templates-user/"
          mode="0755"/>
  </PERMS>
  
</PLUGIN>
